<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Low Power Assistant Middleware Library 4.0.0: Low Power Assistant Middleware Library 4.0.0</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="infineon_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Low Power Assistant Middleware Library 4.0.0</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Low Power Assistant Middleware Library 4.0.0 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_lpa_overview"></a>
Overview</h1>
<p>Power consumption is a key operational factor for embedded devices. The Low Power Assistant (LPA) allows you to configure a PSoC 6 MCU and WLAN (Wi-Fi / BT Radio) device to provide low-power features. This framework presents a unified, low-overhead, user-friendly way to configure, connect, and operate within multiple tasks / cases.</p>
<p>The key points for LPA include:</p>
<ul>
<li>Applies to MCU, Wi-Fi, and BT</li>
<li>This is for RTOS-oriented applications (FreeRTOS, Mbed OS, Amazon FreeRTOS).</li>
<li>Only the configuration is required; no functions should be called in runtime. Once the LPA middleware is configured, it is transparent to the application. Application code changes are not needed and the application runs as normal.</li>
<li>There are different flows:<ul>
<li>ModusToolbox Device Configurator Flow.</li>
<li>Manual Configuration Flow.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="section_lpa_features"></a>
Features</h2>
<p>There are various use cases for the LPA covered in the following sections. The LPA allows you to configure different parts of your design to be energy efficient.</p>
<ul>
<li><a class="el" href="index.html#group_lpa_p1">Part 1. MCU Low Power</a> Provides the integration between the low-power firmware and the IoT framework (most notably, the RTOS) used in the system to be energy efficient.</li>
<li><a class="el" href="index.html#group_lpa_p2">Part 2. Wi-Fi Low Power</a><ul>
<li><a class="el" href="index.html#group_lpa_p2_host_wake">Wi-Fi Host-wake Signal</a> Provides a way for a WLAN device to wake up the Host MCU from its low-power state.</li>
<li><a class="el" href="index.html#group_lpa_p2_arp_offload">Wi-Fi Address Resolution Protocol (ARP) Offload</a> Improves the power consumption of your connected system by reducing the time the Host needs to stay awake due to ARP broadcast traffic. In general, the ARP Offload reduces broadcast traffic.</li>
<li><a class="el" href="index.html#group_lpa_p2_packet_filter">Wi-Fi Packet Filter Offload</a> Allows the host processor to limit which types of packets get passed up to the host processor from the WLAN subsystem. This is useful to keep out unwanted/unneeded packets from the network that might otherwise wake up the host out of a power saving Deep Sleep mode, or prevent it from entering Deep Sleep mode.</li>
<li><a class="el" href="index.html#group_lpa_p2_tcp_keepalive">Wi-Fi TCP Keep Alive Offload</a> Improves the power consumption of your Host MCU by offloading TCP Keepalive to WLAN Firmware</li>
</ul>
</li>
<li><a class="el" href="index.html#group_lpa_p3">Part 3. Bluetooth Low Power</a> Configures BT low-power features that enable the host to achieve its lowest power function. It also configures the wake host interrupt signal (device to host) and related device integration.</li>
</ul>
<p>The listed capabilities make the LPA middleware useful for a variety of applications, including automotive, IoT, and industrial.</p>
<p>The LPA middleware provides an easy way to make the low-power features of Cypress devices available to developers in the form of a portable configuration layer. LPA consists of the following components:</p><ul>
<li>One of these components is a configurator tool (using a personality), which makes the low-power features of the system easy to use (<a href="https://www.cypress.com/ModusToolboxDeviceConfig"><b>ModusToolbox Device Configurator Tool Guide</b></a>). This personality writes data structures that are processed by firmware and implement the choices made in the personality.</li>
<li>This firmware is another component of the LPA feature. The firmware is used at system initialization and does not require user interaction.</li>
<li>A small firmware module provides the integration between the low-power firmware and the IoT framework (most notably the RTOS) used in the system. This final piece of firmware will be part of the IoT framework you are using.</li>
</ul>
<h1><a class="anchor" id="section_lpa_getting_started"></a>
Getting Started</h1>
<p>The LPA middleware can be used in various software environments including Mbed OS, FreeRTOS and Amazon FreeRTOS. The quickest way to get started is by using the Code Examples. Cypress Semiconductor continuously extends its portfolio of code examples at the <a href="http://www.cypress.com"><b>Cypress Semiconductor website</b></a> and at the <a href="https://github.com/Infineon"><b>Cypress Semiconductor GitHub</b></a> website. The following Quick Start Guide sections describe several use cases for using the LPA features:</p><ul>
<li>MCU Low Power <a class="el" href="index.html#group_lpa_p1_qsg_general">Quick Start Guide</a></li>
<li>Wi-Fi Host Wake Signal <a class="el" href="index.html#group_lpa_p2_host_wake_qsg">Quick Start Guide</a></li>
<li>Wi-Fi Address Resolution Protocol (ARP) Offload <a class="el" href="index.html#group_lpa_p2_arp_offload_qsg">Quick Start Guide</a></li>
<li>Wi-Fi Packet Filter Offload <a class="el" href="index.html#group_lpa_p2_packet_filter_qsg">Quick Start Guide</a></li>
<li>Wi-Fi TCP Keepalive Offload <a class="el" href="index.html#group_lpa_p2_tcp_keepalive_qsg">Quick Start Guide</a></li>
<li>Bluetooth Low Power <a class="el" href="index.html#group_lpa_p3_qsg">Quick Start Guide</a></li>
</ul>
<p>Refer to the <a class="el" href="index.html#section_lpa_toolchain">Supported Software and Tools</a> section for compatibility information.</p>
<p>Refer to the <a class="el" href="index.html#group_lpa_changelog">Changelog</a> for the differences between the Middleware versions.</p>
<p>The LPA efficiency for several use cases is included in the <a class="el" href="index.html#section_lpa_performance">Performance Data</a> section.</p>
<p>For more details about LPA and ModusToolbox, refer to the <a class="el" href="index.html#section_lpa_more_information">More Information</a> section.</p>
<h1><a class="anchor" id="section_lpa_Prerequisites"></a>
Prerequisites</h1>
<ul>
<li>A development environment configured for Mbed OS/ FreeRTOS. Refer to the <a class="el" href="index.html#section_lpa_toolchain">Supported Software and Tools</a> section for the required Mbed OS / FreeRTOS / Amazon FreeRTOS version.</li>
<li>Availability of the CY8CKIT-062S2-43012 pioneer kit (or other kits that supports PSoC 6 power consumption measurement).<br />
 The CY8CKIT-062S2-43012 kit is recommended, since this section documents measurement instructions for this kit. If other kit is used, refer to its documentation and learn how to measure current consumed.</li>
<li>For Only Mbed OS, Execute below command for CY8CKIT-062S2-43012 first time <div class="fragment"><div class="line">python -m pip install --upgrade pip</div><div class="line">pip install mbed-ls --upgrade</div><div class="line">mbedls -m 190B:CY8CKIT_062S2_43012</div></div><!-- fragment --></li>
<li>DC Power Monitor or Ammeter.</li>
</ul>
<h1><a class="anchor" id="group_lpa_definitions"></a>
Definitions</h1>
<p>This section lists definitions used throughout this document.</p>
<table class="doxtable">
<tr>
<th>Acronym/Term</th><th>Definition</th><th>Remark </th></tr>
<tr>
<td>AP </td><td>Access Point </td><td>Wireless Access Point connection for the Device (e.g., Wireless Router). </td></tr>
<tr>
<td>ARP </td><td>Address Resolution Protocol </td><td>ARP is a procedure for mapping a dynamic Internet Protocol (IP) address to a permanent physical machine address in a local area network (LAN). </td></tr>
<tr>
<td>TKO </td><td>TCP Keepalive Offload </td><td></td></tr>
<tr>
<td>BT </td><td>Bluetooth </td><td>Bluetooth is a wireless technology standard. </td></tr>
<tr>
<td>Device </td><td>WLAN Device </td><td>The Wi-Fi and/or BT radio module (WLAN Processor). </td></tr>
<tr>
<td>Host </td><td>Host Processor </td><td>The Host (or Application) processor (e.g., PSoC 6). </td></tr>
<tr>
<td>LPA </td><td>Low Power Assistant </td><td></td></tr>
<tr>
<td>OLM </td><td>Offload Manager </td><td></td></tr>
<tr>
<td>OOB </td><td>Out-Of-Band </td><td></td></tr>
<tr>
<td>Configurator </td><td>Cypress Configuration Tool </td><td>Configurators are a set of powerful but intuitive tools that work together to set up various MCU features. Each Configurator generates very readable, user-modifiable firmware to initialize the whole device with a single function call. Refer to <a href="https://www.cypress.com/products/modustoolbox-software-environment"><b>ModusToolBox</b></a> </td></tr>
<tr>
<td>Personality </td><td>Information File </td><td>Personalities are files that define how resources are used by a Configurator. The Low Power Assistant functionality is embedded in the Device Configurator as a personality. </td></tr>
<tr>
<td>SDIO </td><td>Secure Digital Input / Output </td><td></td></tr>
<tr>
<td>WLAN </td><td>Wireless Local Area Network </td><td>WLAN means any wireless local area network no matter what technology is used and Wi-Fi is a type of WLAN that follows the IEEE 802.11 standards </td></tr>
<tr>
<td>AFR </td><td>Amazon FreeRTOS </td><td></td></tr>
<tr>
<td>MTB </td><td>ModusToolbox </td><td>Refer to <a href="https://www.cypress.com/products/modustoolbox-software-environment"><b>ModusToolBox</b></a> </td></tr>
</table>
<h1><a class="anchor" id="group_lpa_p1"></a>
Part 1. MCU Low Power</h1>
<p>The MCU low-power feature allows you to take advantage of the power saving features of a PSoC MCU simply by configuring a few parameters. Using the MCU low-power feature, you can configure the system to achieve maximum power savings during system idling or to establish maximum performance by operating only in Active power mode. This feature works in conjunction with real time operating systems (RTOS), such as Mbed OS.</p>
<p>There are two parameters available: System Idle Power Mode and Deep Sleep Latency.</p>
<p>The System Idle Power Mode parameter defines the power state that the MCU needs to enter automatically any time the system is idle. Setting it to Active power mode disables power saving and allows the system to perform tasks with less intervention, since there are no transitions to / from CPU Sleep / System Deep Sleep states.</p>
<p>The Deep Sleep Latency parameter controls if the desired deep sleep time is larger than needed to perform a transition from System Deep Sleep to Active power mode to perform tasks.</p>
<p>For additional information please refer the SysPm (System Power Management) documentation <a href="https://infineon.github.io/mtb-pdl-cat1/pdl_api_reference_manual/html/group__group__syspm.html">https://infineon.github.io/mtb-pdl-cat1/pdl_api_reference_manual/html/group__group__syspm.html</a></p>
<p>The LPA library provides features for MCU Low Power, Wi-Fi Low Power and Bluetooth Low Power but the LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<h2><a class="anchor" id="group_lpa_p1_qsg_general"></a>
Quick Start Guide</h2>
<p>This section provides step-by-step instructions for how to use the MCU Low Power feature with Mbed OS , FreeRTOS and Amazon FreeRTOS, as well as its impact on the device power consumption.</p>
<p>Perform the following steps to evaluate the device power consumption with different MCU Low Power configurations:</p>
<h3><a class="anchor" id="group_lpa_p1_qsg"></a>
MBEDOS</h3>
<ol type="1">
<li>Import the mbed-os-example-blinky example project and switch to the example directory: <div class="fragment"><div class="line">mbed <span class="keyword">import</span> mbed-os-example-blinky</div><div class="line">cd mbed-os-example-blinky</div></div><!-- fragment --></li>
<li>Set the desired System Idle Power mode (DeepSleep, Sleep or Active). In Mbed OS, the System Idle Power mode is set to Deep Sleep by default to achieve the best power saving. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>MCU Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>MCU Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li>update the main.cpp file with below change to change LED ON time to 5secs along with Psoc Wake setting during LED On state <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;mbed.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;platform/mbed_thread.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// Blinking rate in milliseconds</span></div><div class="line"><span class="preprocessor">#define BLINKING_RATE_MS        5000</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <span class="comment">// Initialise the digital pin LED1 as an output</span></div><div class="line">    DigitalOut led(LED1);</div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div><div class="line">       <span class="comment">// Turn on the onboard Led to indicate the thread Active state.</span></div><div class="line">      led = 0;</div><div class="line"></div><div class="line">      <span class="comment">// The Cy_SysLib_Delay() implements a loop that blocks further</span></div><div class="line">      <span class="comment">// code execution for the specified period of time.</span></div><div class="line">      <span class="comment">// This call is used to keep the thread in the Active state long enough</span></div><div class="line">      <span class="comment">// to evaluate the PSoC power consumption in the Active state.</span></div><div class="line">      Cy_SysLib_Delay(BLINKING_RATE_MS);</div><div class="line"></div><div class="line">      <span class="comment">// Turn off the onboard LED to indicate thread Idle state.</span></div><div class="line">      led = 1;</div><div class="line"></div><div class="line">      <span class="comment">// Put the thread into the Idle state to evaluate the PSoC power</span></div><div class="line">      <span class="comment">// consumption in the configured System Idle Power mode state.</span></div><div class="line">      thread_sleep_for(BLINKING_RATE_MS);</div><div class="line">   }</div><div class="line">}</div></div><!-- fragment --></li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
</li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. Observe the power consumption in different states of the main thread (Active, Idle). The illuminated user LED indicates the Active state.The non-illuminated LED indicates the Idle state. The duration of Active/Idle states can be adjusted by changing the BLINKING_RATE_MS macro value in the main.cpp file. Refer to the following picture for an example of the DC Power Analyzer output:</p>
<p class="startli">i. PSoC6 Active state current average <br />
 <b>Note</b> High Active current is due to PSoC running in LP mode at high system clock frequency and other peripherals are active.</p>
<div class="image">
<img src="mod_blinky_active_inv.jpg" alt="mod_blinky_active_inv.jpg" height="500px"/>
</div>
<p class="startli">ii. PSoC6 Deep Sleep state current average</p>
<div class="image">
<img src="mod_blinky_sleep_inv.jpg" alt="mod_blinky_sleep_inv.jpg" height="500px"/>
</div>
</li>
</ol>
<h3><a class="anchor" id="group_lpa_p1_qsg_anycloud"></a>
FREERTOS</h3>
<ol type="1">
<li>Checkout empty app and add FreeRTOS library <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-psoc6-empty-app.git</span></div><div class="line">cd mtb-example-psoc6-empty-app</div></div><!-- fragment --></li>
<li>Add below files to deps folder for CY8CKIT_062S2_43012 <div class="fragment"><div class="line"><span class="preprocessor"># MTB2.1 and lib approach</span></div><div class="line"></div><div class="line">abstraction-rtos.lib :  https:<span class="comment">//github.com/cypresssemiconductorco/abstraction-rtos/#latest-v1.X</span></div><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line">freertos.lib : https:<span class="comment">//github.com/cypresssemiconductorco/freertos/#latest-v10.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach</span></div><div class="line">echo https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div><div class="line">echo https:<span class="comment">//github.com/cypresssemiconductorco/freertos/#latest-v10.X#\$\$ASSET_REPO\$\$/freertos/latest-v10.X &gt; deps/freertos.mtb</span></div></div><!-- fragment --></li>
<li>Delete below libs from deps folder <div class="fragment"><div class="line">deps/TARGET_CY8CPROTO-062-4343W.lib</div></div><!-- fragment --></li>
<li><p class="startli">Add attached (<a href="FreeRTOSConfig.h" rel="stylesheet" type="text/css"><b>FreeRTOSConfig.h</b></a>) to mtb-example-psoc6-empty-app</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Set the desired System Idle Power mode (DeepSleep, Sleep or Active). In FreeRTOS, the System Idle Power mode is set to Deep Sleep by default to achieve the best power saving. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>MCU Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>MCU Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li>Replace main.c file with below code <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cy_pdl.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cyhal.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cybsp.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;FreeRTOS.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;task.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define BLINKING_RATE_MS        5000</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> blinky(<span class="keywordtype">void</span> *args)</div><div class="line">{</div><div class="line">    TickType_t ticks = pdMS_TO_TICKS(BLINKING_RATE_MS) ;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the User LED</span></div><div class="line">    cyhal_gpio_init((cyhal_gpio_t) CYBSP_USER_LED, CYHAL_GPIO_DIR_OUTPUT, CYHAL_GPIO_DRIVE_STRONG, CYBSP_LED_STATE_OFF);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        <span class="comment">//Turn ON LED</span></div><div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">//Add Delay for 5 seconds so that MCU doesnot go to Deep Sleep</span></div><div class="line">        cyhal_system_delay_ms(BLINKING_RATE_MS);</div><div class="line">        <span class="comment">//Turn OFF LED</span></div><div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">true</span>);</div><div class="line">        vTaskDelay(ticks) ;</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the device and board peripherals</span></div><div class="line">    result = cybsp_init() ;</div><div class="line">    <span class="keywordflow">if</span> (result != CY_RSLT_SUCCESS)</div><div class="line">    {</div><div class="line">        CY_ASSERT(0);</div><div class="line">    }</div><div class="line">    __enable_irq();</div><div class="line"></div><div class="line">    xTaskCreate( blinky, <span class="stringliteral">&quot;Blinky Task&quot;</span>, 1024*10,  0,  1,  0);</div><div class="line">    <span class="comment">// Start the FreeRTOS scheduler</span></div><div class="line">    vTaskStartScheduler();</div><div class="line">}</div></div><!-- fragment --></li>
<li>Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> How to Measure Power Consumption section for corresponding instructions. Observe the power consumption in different states of the main thread (Active, Idle). The illuminated user LED indicates the Active state.The non-illuminated LED indicates the Idle state. The duration of Active/Idle states can be adjusted by changing the BLINKING_RATE_MS value in the blinky function. Refer to the following picture for an example of the DC Power Analyzer output:</p>
<div class="image">
<img src="FreeRTOS_blinky_current.png" alt="FreeRTOS_blinky_current.png" height="500px"/>
</div>
</li>
</ol>
<h3><a class="anchor" id="group_lpa_p1_qsg_afr"></a>
AFR</h3>
<ol type="1">
<li>Checkout AFR example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/projects/cypress/</div><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/afr-example-wlan-lowpower.git</span></div><div class="line">cd afr-example-wlan-lowpower</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present (config_files folder):</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Update vApplicationDaemonTaskStartupHook function in main.c file with below code <div class="fragment"><div class="line"><span class="keywordtype">void</span> vApplicationDaemonTaskStartupHook( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    uint32_t blink_rate = 5000; <span class="comment">// LED BLINK RATE in MS</span></div><div class="line">    TickType_t ticks = pdMS_TO_TICKS(blink_rate) ;</div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        <span class="comment">//Turn ON LED</span></div><div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">//Add Delay for 5 seconds so that MCU doesnot go to Deep Sleep</span></div><div class="line">        Cy_SysLib_Delay(blink_rate);</div><div class="line">        <span class="comment">//Turn OFF LED</span></div><div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">true</span>);</div><div class="line">        vTaskDelay(ticks) ;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></li>
<li>Set the desired System Idle Power mode (DeepSleep, Sleep or Active). In AFR, the System Idle Power mode is set to Deep Sleep by default to achieve the best power saving. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>MCU Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>MCU Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p1_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-lowpower</div><div class="line">cmake -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=../../../tools/cmake/toolchains/arm-gcc.cmake</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p class="startli"><b> Make </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-lowpower</div><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Program the board with afr-example-wlan-lowpower.elf file generated under below folder using <a href="https://www.cypress.com/products/psoc-programming-solutions"><b> Cypress Programmer </b></a> <br />
 CMake : <em>amazon-freertos/projects/cypress/afr-example-wlan-lowpower/build/</em> <br />
 Make : <em>amazon-freertos/build/cy/afr-example-wlan-lowpower/CY8CKIT-062S2-43012/Debug</em> <br />
</li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> How to Measure Power Consumption section for corresponding instructions. Observe the power consumption in different states of the main thread (Active, Idle). The illuminated user LED indicates the Active state.The non-illuminated LED indicates the Idle state. The duration of Active/Idle states can be adjusted by changing the blink_rate variable in the <em>vApplicationDaemonTaskStartupHook</em> function.</p>
<p class="startli">Refer to the following picture for an example of the DC Power Analyzer output:</p>
<div class="image">
<img src="afr_blinky_current_low.png" alt="afr_blinky_current_low.png" height="500px"/>
</div>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p1_cc"></a>
MCU Low Power Configuration Considerations</h2>
<p>The following are the different flows to configure LPA middleware:</p><ul>
<li><a class="el" href="index.html#group_lpa_p1_cc_mt_flow">ModusToolbox Device Configurator Flow</a>. Generating the initialization code using the ModusToolbox Device Configurator greatly simplifies configuring the PSoC and enabling the LPA features. The ModusToolbox Device Configurator provides the user interface to set up and automatically generate the initialization code (including analog routing) and configuration structures.</li>
<li><a class="el" href="index.html#group_lpa_p1_cc_manual_flow">Manual Configuration Flow</a>. Manually adding settings into configuration files. Manual implementation of the initialization code (including analog routing) and configuration structures is recommended for expert users only.</li>
</ul>
<p><b>Note</b> If you modify the output of the ModusToolbox Device Configurator, you cannot import it back into the tool.</p>
<h3><a class="anchor" id="group_lpa_p1_cc_mt_flow"></a>
ModusToolbox Device Configurator Flow</h3>
<ul>
<li><p class="startli">Mandatory steps to avoid design.modus file modification in checkout repo</p>
<p class="startli"><b>MbedOS</b> <br />
</p><ol type="1">
<li>Copy folder mbed-os-example-blinky/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-blinky folder</li>
<li>Delete all files in mbed-os-example-blinky/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-blinky/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-blinky/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-blinky/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-blinky folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS) <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ol>
<p class="startli"><b>FreeRTOS</b> <br />
</p><ol type="1">
<li>Copy contents of folder mtb-example-psoc6-empty-app/libs/TARGET_CY8CKIT-062S2-43012/COMPONENT_BSP_DESIGN_MODUS to mtb-example-psoc6-empty-app/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT_062S2_43012 folder</li>
<li>Delete design.cyqspi and design.cycapsense file in mtb-example-psoc6-empty-app/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>update Makefile in mtb-example-psoc6-empty-app folder with below details (This will tell build to ignore the BSP configuration inside libs folder) <div class="fragment"><div class="line">COMPONENTS+=CUSTOM_DESIGN_MODUS</div><div class="line">DISABLE_COMPONENTS=BSP_DESIGN_MODUS </div></div><!-- fragment --></li>
</ol>
</li>
<li>Navigate to the ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <br />
 <b>MBEDOS:</b> <em>mbed-os-example-blinky/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em> <br />
 <b>FreeRTOS:</b> <em>mtb-example-psoc6-empty-app/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT_062S2_43012/design.modus</em> <br />
 <b>AFR:</b> <em>amazon-freertos/projects/cypress/afr-example-wlan-lowpower/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em> <br />
</li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Select the Host device tab, and then select the System tab for that device.</li>
<li>Enable the Power personality (if disabled) and go to the Power Parameters pane to configure the LPA Middleware.</li>
<li>Configure RTOS related parameters:<ol type="1">
<li>System Idle Power Mode (Active/Sleep/DeepSleep)</li>
<li>Deep Sleep Latency</li>
</ol>
</li>
<li>Perform File-&gt;Save to generate initialization code.</li>
</ul>
<div class="image">
<img src="Power_Personality.png" alt="Power_Personality.png"/>
</div>
<p>After saving the configuration file, the generated code is available under the GeneratedSource folder, located in the same directory as the design.modus file in the BSP:</p><ul>
<li>C Data File: GeneratedSource/cycfg_platform.c</li>
<li>C Header File: GeneratedSource/cycfg_platform.h</li>
</ul>
<h3><a class="anchor" id="group_lpa_p1_cc_manual_flow"></a>
Manual Configuration Flow</h3>
<p>Manual configuration is only recommended for experts. To configure the MCU LPA Middleware related parameters not using the ModusToolbox Device Configurator, do the following steps:</p>
<ol type="1">
<li>Find and open the cycfg_system.h file under .../GeneratedSource/ folder with a text editor.</li>
<li>Configure the System Idle Power Mode parameter value by adding / modifying the following macro with one of the possible options: <div class="fragment"><div class="line"><span class="comment">// Possible options</span></div><div class="line"><span class="preprocessor">#define CY_CFG_PWR_MODE_ACTIVE 0x04UL</span></div><div class="line"><span class="preprocessor">#define CY_CFG_PWR_MODE_SLEEP 0x08UL</span></div><div class="line"><span class="preprocessor">#define CY_CFG_PWR_MODE_DEEPSLEEP 0x10UL</span></div><div class="line"><span class="comment">// Selected option</span></div><div class="line"><span class="preprocessor">#define CY_CFG_PWR_SYS_IDLE_MODE CY_CFG_PWR_MODE_DEEPSLEEP</span></div></div><!-- fragment --></li>
<li>Configure the Deep Sleep Latency parameter value by adding / modifying the following macro with a value from a range 0-10: <div class="fragment"><div class="line"><span class="preprocessor">#define CY_CFG_PWR_DEEPSLEEP_LATENCY 0UL</span></div></div><!-- fragment --></li>
<li>Save changes.</li>
</ol>
<p><b>Note</b> Using the ModusToolbox Device Configurator overwrites changes you made in the cycfg_system.h file.</p>
<h3><a class="anchor" id="group_lpa_p1_cc_parameters"></a>
Configuration Parameters</h3>
<p>The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>RTOS </td><td>System Idle Power Mode </td><td>Selects the lowest power mode the system attempts to enter when there are no active tasks to execute; that is, the system is in idle state. This option only applies to an RTOS based application. </td><td><ul>
<li>System Deep Sleep (default)</li>
<li>CPU Sleep</li>
<li>Active </li>
</ul>
</td></tr>
<tr>
<td>RTOS </td><td>Deep Sleep Latency (ms) </td><td>Selects the greater value among time required to enter in and exit from the Deep Sleep power mode. This option only applies to an RTOS based application. </td><td><ul>
<li>0 (default)</li>
<li>0-10 </li>
</ul>
</td></tr>
</table>
<h1><a class="anchor" id="group_lpa_p2"></a>
Part 2. Wi-Fi Low Power</h1>
<p>LPA library provides features for MCU Low Power, Wi-Fi Low Power and Bluetooth Low Power. LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<p>WLAN FW supports various offloads that continue operations on behalf of the host while the host is asleep. Making the best use of these FW offloads requires proper configuration, as well as coordination with the host OS and host power management systems. Up until now it has been the responsibility of each application developer to realize FW offloads even exist, figure out how to use and configure them, and coordinate with the power management system on the host. The offloads manager (OLM) is responsible for:</p><ul>
<li>Encapsulating the configuration, coordination, and knowledge of WLAN offloads into a single, portable, easy-to-use middleware.</li>
<li>Providing a consistent means of developing offloads.</li>
<li>Providing a platform agnostic configuration and initialization interface.</li>
</ul>
<p>Integrating WLAN offloads on the host has typically been performed by customers or hard-coded into the WLAN driver. With the introduction of an offload configurator, customers can configure a range of offloads. This configuration is consistent and portable since multiple platforms perform similar steps to integrate any particular offload.</p>
<p>Power consumption is a key operational factor for embedded devices. WLAN offloads play a key role in determining host power consumption since offloads let the host go into System Deep Sleep for extended periods of time while handling things like 802.11 roaming, ARP, IPV6 neighbor resolution, key rotation, TCP keep alive, etc. on behalf of the host.</p>
<p>However, each one of these different offloads needs to be recognized, configured, connected to the power management subsystem, and debugged. Currently, this needs be done by each individual application developer. Due to this high overhead, offloads are often overlooked and therefore power consumption not as low as it could be.</p>
<p>The LPA middleware provides a framework that manages WLAN offloads, reduces the overhead incurred by application developers, and makes our offloads more usable while reducing host power consumption.</p>
<p>The framework:</p><ul>
<li>Encapsulates the programming for all low-power offloads it supports. Applications writers don't need to know these details.</li>
<li>Uses the ModusToolbox Device Configurator and personalities to configure:<ul>
<li>which offloads will get compiled in.</li>
<li>parameters for each offload.</li>
</ul>
</li>
<li>Each offload has its own set of configured parameters and its own implementation. Offloads do not call functionality contained in another offload.</li>
<li>Provides a consistent means of developing offloads.</li>
<li>Is adaptable to new offloads being offered by the firmware.</li>
<li>Is easily portable new hosts and new architectures. Therefore, the OLM is independent on the platform and network stack.</li>
<li>Code efficient:<ul>
<li>Minimal space: The object code for an offload driver that is never used at run-time is not linked into the program image.</li>
<li>Static memory usage: no runtime calls to malloc/free.</li>
</ul>
</li>
<li>The framework supports multiple WLAN host driver instances. That is, a collection of offload driver instances and configurations are applied per WLAN host driver instance.</li>
</ul>
<p>Each offload can be enabled or disabled at build-time.</p>
<h2><a class="anchor" id="group_lpa_p2_host_wake"></a>
Wi-Fi Host-wake Signal</h2>
<p>Host-wake provides a way for a WLAN device to wake up the Host MCU from its low-power state. Host-wake is implemented using a GPIO on the MCU that is connected to the WLAN device. The WLAN device asserts the host-wake GPIO to bring the host MCU out of its low-power state. This interrupt is called an out-of-band (OOB) interrupt. This configuration is critical for all the WLAN Low power offload like ARP, Packet Filter, TCP Keep alive to wake up Host MCU out of its low power state.</p>
<p>Refer to the <a class="el" href="index.html#group_lpa_p2_cc">Wi-Fi Low Power Configuration Considerations</a> section to configure the Host-wake pin on the Host. The Host-wake pin polarity is configurable. The WLAN device is configured to re-route the SDIO in-band card interrupt to WL_HOST_WAKE (OOB GPIO interrupt). The following diagram shows connections between the Host and WLAN device:</p>
<div class="image">
<img src="HostWakeSignal.png" alt="HostWakeSignal.png" height="150px"/>
</div>
<p>Where:</p><ul>
<li>SDIO: clock, data</li>
<li>WL_HOST_WAKE: OOB interrupt line to wake Host for service</li>
</ul>
<h3><a class="anchor" id="group_lpa_p2_host_wake_qsg"></a>
Quick Start Guide</h3>
<p>This Quick Start Guide demonstrates how to configure and use the WLAN_HOST_WAKE pin for the MCU Low Power feature in the Mbed OS environment. This guide also shows the feature's impact on the system's low power.</p>
<h4><a class="anchor" id="group_lpa_p2_host_wake_qsg_mbedos"></a>
MBEDOS</h4>
<p>The mbed-os-example-wifi is used as a base for this guide on the CY8CKIT_062S2_43012 pioneer kit. This section assumes that you have an Mbed OS development environment configured. Refer to <a href="https://os.mbed.com/getting-started/">https://os.mbed.com/getting-started/</a> for instructions about how to do that.</p>
<p>By default, the WLAN_HOST_WAKE pin is configured for Cypress boards. If you use another board you might need to modify / change the WLAN_HOST_WAKE assignment and verify it is configured properly.</p>
<p>Perform the following steps:</p>
<ol type="1">
<li>Import the mbed-os-example-wifi example project and switch to the example directory: <div class="fragment"><div class="line">mbed <span class="keyword">import</span> mbed-os-example-wifi</div><div class="line">cd mbed-os-example-wifi</div></div><!-- fragment --></li>
<li>Execute the following command in order to update Mbed OS, download the LPA middleware : <div class="fragment"><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/lpa/</span></div><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/connectivity-utilities</span></div><div class="line">mbed deploy</div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters:<ul>
<li>Modify mbed_app.json to update "wifi-ssid" and "wifi-password" values as desired: <div class="fragment"><div class="line">...</div><div class="line">    <span class="stringliteral">&quot;wifi-ssid&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi SSID&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;SSID\&quot;&quot;</span></div><div class="line">    },</div><div class="line">    <span class="stringliteral">&quot;wifi-password&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi Password&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;PASSWORD\&quot;&quot;</span></div><div class="line">    }</div><div class="line">...</div></div><!-- fragment --><ul>
<li>Add "MBED" Component to mbed_app.json in target_overrides section which is required for compiling helpers in LPA code <br />
 "target.components_add": ["MBED"] <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;MBED&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Optional: modify main.cpp to update Wi-Fi security settings: <div class="fragment"><div class="line"><span class="keywordtype">int</span> ret = wifi-&gt;connect(MBED_CONF_APP_WIFI_SSID, MBED_CONF_APP_WIFI_PASSWORD, NSAPI_SECURITY_WPA_WPA2);</div></div><!-- fragment --> Modify the last parameter if needed to either: <div class="fragment"><div class="line">NSAPI_SECURITY_NONE</div><div class="line">NSAPI_SECURITY_WEP</div><div class="line">NSAPI_SECURITY_WPA</div><div class="line">NSAPI_SECURITY_WPA2</div><div class="line">NSAPI_SECURITY_WPA_WPA2</div><div class="line">NSAPI_SECURITY_WPA3</div></div><!-- fragment --></li>
</ul>
</li>
<li>Modify main.cpp to go to deep-sleep after connecting to the Wi-Fi Access Point. MBED uses LWIP as the network stack. LWIP has periodic timers (smallest timer ~100ms), which wake up the Host MCU periodically. Do the following to suspend these timers. This is needed to demonstrate/verify that WLAN_HOST_WAKE pin is properly configured, and that the Host MCU does not wake up from any other reason other than OOB from WLAN device due to Network activity.<ul>
<li>Include WhdSTAInterface.h and network_activity_handler.h: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;WhdSTAInterface.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;network_activity_handler.h&quot;</span></div></div><!-- fragment --></li>
<li>Add the following declarations: <div class="fragment"><div class="line"><span class="comment">// This macro specifies the interval in milliseconds that the device monitors</span></div><div class="line"><span class="comment">// the network for inactivity. If the network is inactive for duration lesser </span></div><div class="line"><span class="comment">// than INACTIVE_WINDOW_MS in this interval, the MCU does not suspend the network </span></div><div class="line"><span class="comment">// stack and informs the calling function that the MCU wait period timed out </span></div><div class="line"><span class="comment">// while waiting for network to become inactive.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_INTERVAL_MS    (300u)</span></div><div class="line"></div><div class="line"><span class="comment">// This macro specifies the continuous duration in milliseconds for which the </span></div><div class="line"><span class="comment">// network has to be inactive. If the network is inactive for this duration, the</span></div><div class="line"><span class="comment">// MCU will suspend the network stack. Now, the MCU will not need to service the</span></div><div class="line"><span class="comment">// network timers which allows it to stay longer in sleep/deepsleep.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_WINDOW_MS      (200u)</span></div></div><!-- fragment --></li>
<li>Modify main.cpp to allow the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. For this, replace the line "wifi-&gt;disconnect();" with the following code: <div class="fragment"><div class="line"><span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div><div class="line">    <a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(static_cast&lt;WhdSTAInterface*&gt;(wifi),</div><div class="line">       osWaitForever, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Verify WLAN_HOST_WAKE pin configurations using device configurator<ul>
<li>Mandatory steps to avoid design.modus file modification in mbed-os folder<ol type="a">
<li>Copy folder mbed-os-example-wifi/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-wifi folder</li>
<li>Delete all files in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-wifi folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS) <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ol>
</li>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml (For MTB2.2, point to mtb_shared/mtb-pdl-cat1/&lt;&gt;/devicesupport.xml) file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS -DMBED_CPU_STATS_ENABLED --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash --sterm</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
<p class="startli">MBED_CPU_STATS_ENABLED : This helps to understand how much time MCU remained in sleep state</p>
<p class="startli">When the modified mbed-os-example-wifi starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">Scan:</div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Oct 29 2019 22:00:20 version 13.10.271.215 (r723093) FWID 01-f268ebc9</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2019-10-29 21:50:17</div><div class="line">WHD VERSION      : v1.50.0-rc1 : v1.50.0-rc1 : GCC 7.3 : 2019-10-30 18:42:31 +0530</div><div class="line">Network: airport_5g secured: WPA2 BSSID: 24:A2:E1:f0:50:25 RSSI: -84 Ch: 36</div><div class="line">Network: Broadcom secured: None BSSID: 0:10:18:ee:b5:f7 RSSI: -52 Ch: 36</div><div class="line">Network: test_2nd_cy secured: WPA2 BSSID: F8:32:E4:b0:ff:8c RSSI: -74 Ch: 36</div><div class="line">Network: eero secured: WPA2 BSSID: F8:BB:BF:b2:2:54 RSSI: -33 Ch: 36</div><div class="line">Network: WWD secured: WPA/WPA2 BSSID: 64:A5:C3:64:16:13 RSSI: -77 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:b1:74:b4 RSSI: -36 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:69:2b:8 RSSI: -46 Ch: 36</div><div class="line">Network: prke-bsh5g secured: WPA/WPA2 BSSID: 44:4E:6D:45:b0:58 RSSI: -82 Ch: 36</div><div class="line">Network:  secured: Unknown BSSID: F8:BB:BF:b2:2:52 RSSI: -33 Ch: 36</div><div class="line">Network: testap secured: None BSSID: 0:A0:50:30:81:65 RSSI: -64 Ch: 36</div><div class="line">Network: RW1 secured: WPA2 BSSID: C8:8:73:3c:87:2c RSSI: -75 Ch: 40</div><div class="line">Network: CYFI secured: WPA2 BSSID: B0:B8:67:3b:ac:70 RSSI: -86 Ch: 44</div><div class="line">Network: CYFI secured: WPA2 BSSID: 80:8D:B7:69:77:30 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_GUEST secured: None BSSID: 80:8D:B7:69:77:31 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_ZOOM secured: WPA2 BSSID: 80:8D:B7:69:77:32 RSSI: -70 Ch: 44</div><div class="line">15 networks available.</div><div class="line"></div><div class="line">Connecting to SSID...</div><div class="line">Success</div><div class="line"></div><div class="line">MAC: d4:4d:a4:a0:02:a4</div><div class="line">IP: 192.168.1.12</div><div class="line">Netmask: 255.255.255.0</div><div class="line">Gateway: 192.168.1.1</div><div class="line">RSSI: -29</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">PSoC 6 MCU is in System Deep Sleep. Only WLAN OOB can wake Host up in this situation. Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.</p>
<p class="startli">Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up each command: </p><div class="fragment"><div class="line">C:\&gt;ping 192.168.1.12</div><div class="line"></div><div class="line">Pinging 192.168.1.12 with 32 bytes of data:</div><div class="line">Reply from 192.168.1.12: bytes=32 time=738ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=662ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=727ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=468ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.1.12:</div><div class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">Minimum = 468ms, Maximum = 738ms, Average = 648ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 8906ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:57, rx_total:329, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2260, cmd53_read:1028, cmd53_write:634</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:120, sdio_intrs:312, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --><p> Ping traffic causes WLAN OOB periodically wakes up the host, oob_intrs displayed in the serial terminal output shows the number of WLAN OOB interrupts receieved.</p>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_host_wake_qsg_anycloud"></a>
FREERTOS</h4>
<ol type="1">
<li>Checkout Wi-Fi Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-anycloud-wlan-lowpower.git</span></div><div class="line">cd mtb-example-anycloud-wlan-lowpower</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Add lib file for TARGET_CY8CKIT-062S2-43012 in deps folder and delete deps/TARGET_CY8CPROTO-062-4343W.lib <div class="fragment"><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach , make sure below mtb files are present</span></div><div class="line"><span class="preprocessor">echo https://github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in lowpower_task.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     CY_WCM_SECURITY_WPA2_MIXED_PSK</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in lowpower_task.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Verify WLAN_HOST_WAKE pin configurations using device configurator<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mtb-example-anycloud-wlan-lowpower/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mtb-example-anycloud-wlan-lowpower/libs/psoc6pdl/devicesupport.xml(For MTB2.2, point to mtb_shared/mtb-pdl-cat1/&lt;&gt;/devicesupport.xml) file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --><p class="startli">When the modified mtb-example-anycloud-wlan-lowpower starts, the console output shows that it connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">=======================================================</div><div class="line">CE230106 - Example: WLAN Lowpower</div><div class="line">=======================================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div><div class="line">Info:Connecting to AP</div><div class="line">IP Address 10.0.0.201 assigned</div><div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div><div class="line">Info:Beacon period = 100, DTIM period = 3</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">PSoC 6 MCU is in System Deep Sleep. Only WLAN OOB can wake Host up in this situation. Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.</p>
<p class="startli">Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up each command: </p><div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div><div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div><div class="line">Reply from 10.0.0.201: bytes=32 time=274ms TTL=255</div><div class="line">Reply from 10.0.0.201: bytes=32 time=393ms TTL=255</div><div class="line">Reply from 10.0.0.201: bytes=32 time=396ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div><div class="line">    Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">    Minimum = 274ms, Maximum = 396ms, Average = 354ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 443ms</div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:91, rx_total:97, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2314, cmd53_read:488, cmd53_write:607</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:93, sdio_intrs:187, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter Deep sleep power mode</div></div><!-- fragment --><p> Ping traffic causes WLAN OOB periodically wakes up the host, oob_intrs displayed in the serial terminal output shows the number of WLAN OOB interrupts received.</p>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_host_wake_qsg_afr"></a>
AFR</h4>
<ol type="1">
<li>Checkout Wi-Fi Low Power Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/projects/cypress/</div><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/afr-example-wlan-lowpower.git</span></div><div class="line">cd afr-example-wlan-lowpower</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present (config_files folder):</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in lowpower_task.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     eWiFiSecurityWPA2</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in lowpower_task.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Verify WLAN_HOST_WAKE pin configurations using device configurator<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>amazon-freertos/projects/cypress/afr-example-wlan-lowpower/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the amazon-freertos/vendors/cypress/psoc6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
</ul>
</li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-lowpower</div><div class="line">cmake -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=../../../tools/cmake/toolchains/arm-gcc.cmake</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p> <b> Make </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-lowpower</div><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Program the board with afr-example-wlan-lowpower.elf file generated under below folder using <a href="https://www.cypress.com/products/psoc-programming-solutions"><b> Cypress Programmer </b></a> <br />
 CMake : <em>amazon-freertos/projects/cypress/afr-example-wlan-lowpower/build/</em> <br />
 Make : <em>amazon-freertos/build/cy/afr-example-wlan-lowpower/CY8CKIT-062S2-43012/Debug</em> <br />
 When the modified afr-example-wlan-lowpower starts, the console output shows that it connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. <div class="fragment"><div class="line">Info: ==================================</div><div class="line">Info: AFR Example: WLAN Low Power</div><div class="line">Info: ==================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.90.2 : v1.90.2 : GCC 9.2 : 2020-04-13 02:49:57 -0500</div><div class="line">Offloads not configured</div><div class="line">Info: Wi-Fi module initialized. Connecting to AP...</div><div class="line">Info: Wi-Fi connected to AP: SSID</div><div class="line">Info: IP Address acquired: 192.168.43.11</div><div class="line">Info: Beacon period = 100, DTIM period = 3</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 1948ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:67, rx_total:71, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2313, cmd53_read:351, cmd53_write:558</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:68, sdio_intrs:154, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">PSoC 6 MCU is in System Deep Sleep. Only WLAN OOB can wake Host up in this situation. Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.</p>
<p class="startli">Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up each command: </p><div class="fragment"><div class="line">C:\&gt;ping -n 3 192.168.43.11</div><div class="line">Pinging 192.168.43.11 with 32 bytes of data:</div><div class="line">Reply from 192.168.43.11: bytes=32 time=274ms TTL=255</div><div class="line">Reply from 192.168.43.11: bytes=32 time=393ms TTL=255</div><div class="line">Reply from 192.168.43.11: bytes=32 time=396ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.43.11:</div><div class="line">    Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">    Minimum = 274ms, Maximum = 396ms, Average = 354ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 443ms</div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:91, rx_total:97, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2314, cmd53_read:488, cmd53_write:607</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:93, sdio_intrs:187, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter Deep sleep power mode</div></div><!-- fragment --><p> Ping traffic causes WLAN OOB periodically waking up the host, oob_intrs displayed in the serial terminal output shows the number of WLAN OOB interrupts received.</p>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_arp_offload"></a>
Wi-Fi Address Resolution Protocol (ARP) Offload</h2>
<p>The Address Resolution Protocol (ARP) Offload part of the Low Power Assistant is designed to improve the power consumption of your connected system by reducing the time the Host needs to stay awake due to ARP broadcast traffic. In general, the ARP Offload reduces the broadcast traffic. To enable this support, refer to the <a class="el" href="index.html#group_lpa_p2_cc">Wi-Fi Low Power Configuration Considerations</a> section. This document describes how to enable the ARP Offload features that can be incorporated into your project from <a href="https://github.com/cypresssemiconductorco/lpa"><b>Cypress GitHub LPA Middleware</b></a>.</p>
<p>ARP is used for mapping an Internet Protocol address (IP address; ex: 192.168.1.1)) to a physical machine address (MAC; ex: ac:32:df:14:16:07) lookup. ARP uses broadcast frames to accomplish this.</p><ul>
<li>Reduce System Deep Sleep wake-up to reduce Host Processor power consumption.</li>
<li>Reduce Network traffic. If many IoT devices are in one space, the Wi-Fi bands can get congested with unnecessary broadcast traffic.</li>
</ul>
<p>ARP broadcast traffic is normally forwarded from the Network to the Device (Wi-Fi Radio) and then to the Host (Application CPU) Network Stack. If the Host is sleeping, the Device wakes it up. Having the Device handle some of the ARP traffic will reduce the frequency that the Host sleeps/wakes up, reducing Host power consumption by staying in CPU Sleep and System Deep Sleep states longer. Having the Device handle some of the ARP requests from the Host to the network will reduce Network traffic.</p>
<div class="image">
<img src="ARP1.png" alt="ARP1.png" height="500px"/>
</div>
<p>The WLAN ARP Offload feature of the Low Power Assistant will help you to configure the ARP requests handling by the Device.</p>
<h3><a class="anchor" id="group_lpa_p2_awake_sleeping"></a>
Awake vs. Sleeping</h3>
<p>The ARP offload feature of the Low Power Assistant has the following basic modes:</p><ul>
<li>While the Host (Host Processor) is "Awake"</li>
<li>While the Host (Host Processor) is in CPU Sleep or System Deep Sleep.</li>
</ul>
<p>It is possible to enable and configure these modes based on the Sleep status of the Application CPU.</p>
<h3><a class="anchor" id="group_lpa_p2_hostautoreply"></a>
Host Auto Reply</h3>
<p>Host Auto Reply is a power-saving and network traffic reduction feature. Using the ARP Offload Host Auto Reply feature, the Device will answer Host ARP Requests, without broadcasting to the Network. If a Host generated ARP Request results in a cache hit in the Device ARP cache, the Device will fabricate an ARP Response and not forward the request to the Network.</p>
<p>This may be useful when the Host ARP cache is cleared to disable the Host ARP table entry timers prior to entering System Deep Sleep. When the Host is woken up, if the Host ARP cache queries in its own Network Stack and results in a cache miss, the Host ARP Request will be sent to the Device. If the ARP Request results in a cache hit in the Device, the Device will respond without soliciting the network. As long as the Device ARP cache entry hasn't expired, the Device will fabricate an ARP Response to the Host, thus reducing broadcast traffic.</p>
<p>The ARP Agent is enabled by setting the ARP Offload Agent flag and ARP Offload Enable in the Device Configurator. The ARP Agent will store "ARP IP : MAC" combos in the Device ARP cache. The Device ARP cache is filled with IP:MAC combos when ARP Offload and ARP Agent are enabled and the Network has responded to a Host ARP Request. There is an "age out" value that you can set in the ARP Offload configuration to determine the length of time the ARP cache entry is valid. This ensures that the WLAN ARP cache is updated appropriately.</p>
<p>The size of the WLAN Device ARP Cache is 16. The Host Network Stack maintains an ARP cache regardless if the WLAN Device ARP Agent is turned on or not.</p>
<div class="image">
<img src="ARP2.png" alt="ARP2.png" height="550px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_peerautoreply"></a>
Peer Auto Reply</h3>
<p>Peer Auto Reply is another power-saving feature so that the Device can respond to ARP requests from Peers (Network) without waking up the Host Processor.</p>
<p>This is accomplished by setting the ARP Offload Enable and Peer Auto Reply flags in the Device Configurator. When enabled, this feature instructs the Device to answer ARP requests to the Peers without actually asking the Host. This allows the Host to stay in CPU Sleep or System Deep Sleep longer to save power. Once the IP address of the Device is established (that is, the Device has connected to an AP and an IP has been assigned and stored in the Device), the Device will intercept any ARP request sent to the Host, and then fabricate and send an ARP response without involving the Host. If the Host was in CPU Sleep or System Deep Sleep mode, the Host is not awakened.</p>
<p>The max number of entries for this feature is set to 8 (defined in the Device Firmware and is not modifiable).</p>
<div class="image">
<img src="ARP3.png" alt="ARP3.png" height="600px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_hostpeerautoreply"></a>
Host and Peer Auto Reply</h3>
<p><a class="el" href="index.html#group_lpa_p2_hostautoreply">Host Auto Reply</a> and <a class="el" href="index.html#group_lpa_p2_peerautoreply">Peer Auto Reply</a> features can be enabled together for Application CPU Awake mode.</p>
<h3><a class="anchor" id="group_lpa_p2_hostsnoop"></a>
Host IP Snoop</h3>
<p>When enabled, the Snoop facility watches for ARP Responses from the Host to the Network, and caches them in the WLAN Device Host IP Table. The size of this table is 8 entries, which allows for the Device to support multiple IP addresses.</p>
<h3><a class="anchor" id="group_lpa_p2_arp_offload_qsg"></a>
Quick Start Guide</h3>
<p>This Quick Start Guide demonstrates of how to configure and use the ARP offload feature in the Mbed OS, FreeRTOS environment and its impact on the system power consumption.</p>
<h4><a class="anchor" id="group_lpa_p2_arp_offload_qsg_mbedos"></a>
MBEDOS</h4>
<p>The mbed-os-example-wifi is used as a base for this guide on the CY8CKIT_062S2_43012 pioneer kit. This section assumes that you have an Mbed OS development environment configured. Refer to <a href="https://os.mbed.com/getting-started/">https://os.mbed.com/getting-started/</a> for instructions about how to do that.</p>
<p>The following steps are required to set up the mbed-os-example-wifi example and enable the ARP offload feature:</p>
<ol type="1">
<li>Import the mbed-os-example-wifi example project and switch to the example directory: <div class="fragment"><div class="line">mbed <span class="keyword">import</span> mbed-os-example-wifi</div><div class="line">cd mbed-os-example-wifi</div></div><!-- fragment --></li>
<li>Execute the following command in order to replace Mbed OS, download the LPA middleware and connectivity utilities: <div class="fragment"><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/lpa/</span></div><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/connectivity-utilities/</span></div><div class="line">mbed deploy</div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters:<ul>
<li>Modify mbed_app.json to update "wifi-ssid" and "wifi-password" values as desired: <div class="fragment"><div class="line">...</div><div class="line">    <span class="stringliteral">&quot;wifi-ssid&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi SSID&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;SSID\&quot;&quot;</span></div><div class="line">    },</div><div class="line">    <span class="stringliteral">&quot;wifi-password&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi Password&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;PASSWORD\&quot;&quot;</span></div><div class="line">    }</div><div class="line">...</div></div><!-- fragment --><ul>
<li>Add "MBED" Component to mbed_app.json in target_overrides section which is required for compiling helpers in LPA code <br />
 "target.components_add": ["MBED"] <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;MBED&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Optional: modify main.cpp to update Wi-Fi security settings: <div class="fragment"><div class="line"><span class="keywordtype">int</span> ret = wifi-&gt;connect(MBED_CONF_APP_WIFI_SSID, MBED_CONF_APP_WIFI_PASSWORD, NSAPI_SECURITY_WPA_WPA2);</div></div><!-- fragment --> Modify the last parameter if needed to either: <div class="fragment"><div class="line">NSAPI_SECURITY_NONE</div><div class="line">NSAPI_SECURITY_WEP</div><div class="line">NSAPI_SECURITY_WPA</div><div class="line">NSAPI_SECURITY_WPA2</div><div class="line">NSAPI_SECURITY_WPA_WPA2</div><div class="line">NSAPI_SECURITY_WPA3</div></div><!-- fragment --></li>
</ul>
</li>
<li>Modify main.cpp to go to deep-sleep after connecting to the Wi-Fi Access Point. MBED uses LWIP as the network stack. LWIP has periodic timers (smallest timer ~100ms), which wake up the Host MCU periodically. Do the following to suspend these timers, so the Host MCU can be in deep-sleep for a longer time. This is needed to demonstrate / verify ARP offload is not waking up the Host MCU.<ul>
<li>Include WhdSTAInterface.h and network_activity_handler.h: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;WhdSTAInterface.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;network_activity_handler.h&quot;</span></div></div><!-- fragment --></li>
<li>Add the following declarations: <div class="fragment"><div class="line"><span class="comment">// This macro specifies the interval in milliseconds that the device monitors</span></div><div class="line"><span class="comment">// the network for inactivity. If the network is inactive for duration lesser</span></div><div class="line"><span class="comment">// than INACTIVE_WINDOW_MS in this interval, the MCU does not suspend the network</span></div><div class="line"><span class="comment">// stack and informs the calling function that the MCU wait period timed out</span></div><div class="line"><span class="comment">// while waiting for network to become inactive.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_INTERVAL_MS    (300u)</span></div><div class="line"></div><div class="line"><span class="comment">// This macro specifies the continuous duration in milliseconds for which the</span></div><div class="line"><span class="comment">// network has to be inactive. If the network is inactive for this duration, the</span></div><div class="line"><span class="comment">// MCU will suspend the network stack. Now, the MCU will not need to service the</span></div><div class="line"><span class="comment">// network timers which allows it to stay longer in sleep/deepsleep.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_WINDOW_MS      (200u)</span></div></div><!-- fragment --></li>
<li>Modify main.cpp to allow the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. For this, replace the line "wifi-&gt;disconnect();" with the following code: <div class="fragment"><div class="line"><span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div><div class="line">    <a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(static_cast&lt;WhdSTAInterface*&gt;(wifi),</div><div class="line">      osWaitForever, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Configure the ARP offload. The easiest way to configure ARP offload is to use the ModusToolbox Device Configurator.<ul>
<li>Mandatory steps to avoid design.modus file modification in mbed-os folder<ol type="a">
<li>Copy folder mbed-os-example-wifi/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-wifi folder</li>
<li>Delete all files in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-wifi folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS) <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ol>
</li>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable ARP offload.</li>
<li>Set "ARP offload Feature(s)" to "Peer Auto Reply".</li>
<li>Enable "Snoop Host IP From Traffic When ARP Offload Enabled".</li>
<li>Set "ARP Offload Cache Entries Expire after (s)" to 1200.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS -DMBED_CPU_STATS_ENABLED --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash --sterm</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
<p class="startli">MBED_CPU_STATS_ENABLED : This helps to understand how much time MCU remained in sleep state</p>
<p class="startli">When the modified mbed-os-example-wifi starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">Scan:</div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Oct 29 2019 22:00:20 version 13.10.271.215 (r723093) FWID 01-f268ebc9</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2019-10-29 21:50:17</div><div class="line">WHD VERSION      : v1.50.0-rc1 : v1.50.0-rc1 : GCC 7.3 : 2019-10-30 18:42:31 +0530</div><div class="line">Network: airport_5g secured: WPA2 BSSID: 24:A2:E1:f0:50:25 RSSI: -84 Ch: 36</div><div class="line">Network: Broadcom secured: None BSSID: 0:10:18:ee:b5:f7 RSSI: -52 Ch: 36</div><div class="line">Network: test_2nd_cy secured: WPA2 BSSID: F8:32:E4:b0:ff:8c RSSI: -74 Ch: 36</div><div class="line">Network: eero secured: WPA2 BSSID: F8:BB:BF:b2:2:54 RSSI: -33 Ch: 36</div><div class="line">Network: WWD secured: WPA/WPA2 BSSID: 64:A5:C3:64:16:13 RSSI: -77 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:b1:74:b4 RSSI: -36 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:69:2b:8 RSSI: -46 Ch: 36</div><div class="line">Network: prke-bsh5g secured: WPA/WPA2 BSSID: 44:4E:6D:45:b0:58 RSSI: -82 Ch: 36</div><div class="line">Network:  secured: Unknown BSSID: F8:BB:BF:b2:2:52 RSSI: -33 Ch: 36</div><div class="line">Network: testap secured: None BSSID: 0:A0:50:30:81:65 RSSI: -64 Ch: 36</div><div class="line">Network: RW1 secured: WPA2 BSSID: C8:8:73:3c:87:2c RSSI: -75 Ch: 40</div><div class="line">Network: CYFI secured: WPA2 BSSID: B0:B8:67:3b:ac:70 RSSI: -86 Ch: 44</div><div class="line">Network: CYFI secured: WPA2 BSSID: 80:8D:B7:69:77:30 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_GUEST secured: None BSSID: 80:8D:B7:69:77:31 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_ZOOM secured: WPA2 BSSID: 80:8D:B7:69:77:32 RSSI: -70 Ch: 44</div><div class="line">15 networks available.</div><div class="line"></div><div class="line">Connecting to SSID...</div><div class="line">Success</div><div class="line"></div><div class="line">MAC: d4:4d:a4:a0:02:a4</div><div class="line">IP: 192.168.1.12</div><div class="line">Netmask: 255.255.255.0</div><div class="line">Gateway: 192.168.1.1</div><div class="line">RSSI: -29</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up for each command: <div class="fragment"><div class="line">C:\&gt;ping 192.168.1.12</div><div class="line"></div><div class="line">Pinging 192.168.1.12 with 32 bytes of data:</div><div class="line">Reply from 192.168.1.12: bytes=32 time=738ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=662ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=727ms TTL=255</div><div class="line">Reply from 192.168.1.12: bytes=32 time=468ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.1.12:</div><div class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">Minimum = 468ms, Maximum = 738ms, Average = 648ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">  Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 8906ms</div><div class="line"></div><div class="line">  =====================================================</div><div class="line">  WHD Stats..</div><div class="line">  tx_total:57, rx_total:329, tx_no_mem:0, rx_no_mem:0</div><div class="line">  tx_fail:0, no_credit:0, flow_control:0</div><div class="line">  Bus Stats..</div><div class="line">  cmd52:2260, cmd53_read:1028, cmd53_write:634</div><div class="line">  cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">  oob_intrs:120, sdio_intrs:312, error_intrs:0, read_aborts:0</div><div class="line">  =====================================================</div><div class="line"></div><div class="line">  Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe 192.168.1.12</div><div class="line"></div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1124.833ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 121.340ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1122.989ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1119.256ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.1.12/arp</div><div class="line">     4 probes sent.</div><div class="line">     4 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">     Minimum = 121.340ms, Maximum = 1124.833ms, Average = 872.105ms</div></div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Since the WLAN devices ARP cache is empty on the initial ARP request from the peer, it looks up the IP details from the host and updates its ARP cache. This causes the host to wake up because of network activity between the host MCU and the WLAN device. On subsequent ARP requests from the peer, the host remains asleep. The WLAN device continues to respond to the ARP request as it has the ARP data available in its ARP cache.</p>
</li>
<li><p class="startli">Verify the ARP offload is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the ARP offload enabled:</p>
<div class="image">
<img src="arp_offload_inv.jpg" alt="arp_offload_inv.jpg" height="500px"/>
</div>
<p class="startli">While the WLAN device (purple graph) responds to each request, the PSoC 6 MCU (blue graph) is in System Deep Sleep mode.</p>
</li>
</ul>
</li>
<li><p class="startli">Disable the ARP Offload feature and observe that the PSoC 6 MCU wakes up on each request. Launch the ModusToolbox Device Configurator and open the appropriate design.modus file. Select the "CYW943012WKWBG" tab, select Power-&gt;Wi-Fi personality, and disable ARP offload by de-selecting the check box next to "ARP offload". Save the configuration. Then, build and program the application. With ARP offload disabled, the Host MCU (PSoC 6) will wake for every ARP request, as shown in the following power profile.</p>
<div class="image">
<img src="arp_nooffload_inv.jpg" alt="arp_nooffload_inv.jpg" height="500px"/>
</div>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_arp_offload_qsg_anycloud"></a>
FREERTOS</h4>
<p>The following steps are required to set up the wifi-low-power example and enable the ARP offload feature:</p>
<ol type="1">
<li>Checkout Wi-Fi Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-anycloud-wlan-lowpower.git</span></div><div class="line">cd mtb-example-anycloud-wlan-lowpower</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Add lib file for TARGET_CY8CKIT-062S2-43012 in deps folder and delete deps/TARGET_CY8CPROTO-062-4343W.lib <div class="fragment"><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach , make sure below mtb files are present</span></div><div class="line"><span class="preprocessor">echo https://github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in lowpower_task.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     CY_WCM_SECURITY_WPA2_MIXED_PSK</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in lowpower_task.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Configure the ARP offload. The easiest way to configure ARP offload is to use the ModusToolbox Device Configurator.<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mtb-example-anycloud-wlan-lowpower/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mtb-example-anycloud-wlan-lowpower/libs/psoc6pdl/devicesupport.xml (For MTB2.2, point to mtb_shared/mtb-pdl-cat1/&lt;&gt;/devicesupport.xml) file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable ARP offload.</li>
<li>Set "ARP offload Feature(s)" to "Peer Auto Reply".</li>
<li>Enable "Snoop Host IP From Traffic When ARP Offload Enabled".</li>
<li>Set "ARP Offload Cache Entries Expire after (s)" to 1200.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --><p class="startli">When the modified mtb-example-anycloud-wlan-lowpower starts, the console output shows that it connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">=======================================================</div><div class="line">CE230106 - Example: WLAN Lowpower</div><div class="line">=======================================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div><div class="line">Info:Connecting to AP</div><div class="line">IP Address 10.0.0.201 assigned</div><div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div><div class="line">Info:Beacon period = 100, DTIM period = 3</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up for each command: <div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div><div class="line"></div><div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div><div class="line">Reply from 10.0.0.201: bytes=32 time=319ms TTL=255</div><div class="line">Reply from 10.0.0.201: bytes=32 time=233ms TTL=255</div><div class="line">Reply from 10.0.0.201: bytes=32 time=151ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div><div class="line">  Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">  Minimum = 151ms, Maximum = 319ms, Average = 234ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 10.0.0.201</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 113.078ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1115.498ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1113.863ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201/arp</div><div class="line">   3 probes sent.</div><div class="line">   3 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">   Minimum = 113.078ms, Maximum = 1115.498ms, Average = 780.813ms</div></div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Since the WLAN devices ARP cache is empty on the initial ARP request from the peer, it looks up the IP details from the host and updates its ARP cache. This causes the host to wake up because of network activity between the host MCU and the WLAN device. On subsequent ARP requests from the peer, the host remains asleep. The WLAN device continues to respond to the ARP request as it has the ARP data available in its ARP cache.</p>
</li>
<li><p class="startli">Verify the ARP offload is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the ARP offload enabled:</p>
<div class="image">
<img src="FreeRTOS_ARP_Enable.png" alt="FreeRTOS_ARP_Enable.png" height="500px"/>
</div>
<p class="startli">While the WLAN device (purple graph) high spikes responds to each request, the PSoC 6 host (blue graph) is in System Deep Sleep mode.</p>
</li>
</ul>
</li>
<li><p class="startli">Disable the ARP Offload feature and observe that the PSoC 6 Host wakes up on each request. Launch the ModusToolbox Device Configurator and open the appropriate design.modus file. Select the "CYW943012WKWBG" tab, select Power-&gt;Wi-Fi personality, and disable ARP offload by de-selecting the check box next to "ARP offload". Save the configuration. Then, build and program the application. With ARP offload disabled, the Host MCU (PSoC 6) will wake for every ARP request.</p>
<div class="image">
<img src="FreeRTOS_ARP_Disable.png" alt="FreeRTOS_ARP_Disable.png" height="500px"/>
</div>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_arp_offload_qsg_afr"></a>
AFR</h4>
<p>The following steps are required to set up the afr-example-wlan-offloads example and enable the ARP offload feature:</p>
<ol type="1">
<li>Checkout Wi-Fi Low Offloads Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/projects/cypress/</div><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/afr-example-wlan-offloads.git</span></div><div class="line">cd afr-example-wlan-offloads</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in wifi_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     eWiFiSecurityWPA2</span></div></div><!-- fragment --></li>
<li>Modify below macro in wlan_offload.h to use offload configurations from ModusToolbox Device Configurator <div class="fragment"><div class="line"><span class="preprocessor">#define USE_CONFIGURATOR_GENERATED_CONFIG    (1)</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in wlan_offload.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Configure the ARP offload. The easiest way to configure ARP offload is to use the ModusToolbox Device Configurator.<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the amazon-freertos/vendors/cypress/psoc6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable ARP offload.</li>
<li>Set "ARP offload Feature(s)" to "Peer Auto Reply".</li>
<li>Enable "Snoop Host IP From Traffic When ARP Offload Enabled".</li>
<li>Set "ARP Offload Cache Entries Expire after (s)" to 1200.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">cmake -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=../../../tools/cmake/toolchains/arm-gcc.cmake</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p class="startli"><b> Make </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Program the board with afr-example-wlan-offloads.elf file generated under below folder using <a href="https://www.cypress.com/products/psoc-programming-solutions"><b> Cypress Programmer </b></a> <br />
 CMake : <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/build/</em> <br />
 Make : <em>amazon-freertos/build/cy/afr-example-wlan-offloads/CY8CKIT-062S2-43012/Debug</em> <br />
 When the modified afr-example-wlan-offloads starts, the console output shows that it connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. <div class="fragment"><div class="line">Info: ==================================</div><div class="line">Info: AFR Example: WLAN Offloads</div><div class="line">Info: ==================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.90.2 : v1.90.2 : GCC 9.2 : 2020-04-13 02:49:57 -0500</div><div class="line">Info: --Offload Manager is initialized with the device configurator generated configuration--</div><div class="line">Info: Wi-Fi module initialized. Connecting to AP...</div><div class="line">Info: Wi-Fi connected to AP: SSID</div><div class="line">Info: IP Address acquired: 192.168.43.11</div><div class="line">Error: Unable to find TKO offloads configuration</div><div class="line">Error: tcp_socket_connection_start: Offload descriptor TKO not found. No TCP connection has been established.</div><div class="line">Check the TCP Keepalive offload settings in ModusToolbox Device Configurator tool</div><div class="line">Error: One or more TCP socket connections failed.</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 27547ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:81, rx_total:80, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2339, cmd53_read:402, cmd53_write:583</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:79, sdio_intrs:167, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send a "ping" command to the board and observe in the serial terminal that the PSoC 6 MCU wakes up for each command: <div class="fragment"><div class="line">C:\&gt;ping 192.168.43.11 -n 3</div><div class="line"></div><div class="line">Pinging 192.168.43.11 with 32 bytes of data:</div><div class="line">Reply from 192.168.43.11: bytes=32 time=360ms TTL=255</div><div class="line">Reply from 192.168.43.11: bytes=32 time=1394ms TTL=255</div><div class="line">Reply from 192.168.43.11: bytes=32 time=10ms TTL=255</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.43.11:</div><div class="line">    Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div><div class="line">Approximate round trip times in milli-seconds:</div><div class="line">    Minimum = 10ms, Maximum = 1394ms, Average = 588ms</div><div class="line"></div><div class="line">&lt;Terminal logs &gt;</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 192.168.43.11</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 114.427ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 114.142ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 1114.262ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.43.11/arp</div><div class="line">3 probes sent.</div><div class="line">     3 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">     Minimum = 114.142ms, Maximum = 1114.262ms, Average = 447.610ms</div></div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Since the WLAN devices ARP cache is empty on the initial ARP request from the peer, it looks up the IP details from the host and updates its ARP cache. This causes the host to wake up because of network activity between the host MCU and the WLAN device. On subsequent ARP requests from the peer, the host remains asleep. The WLAN device continues to respond to the ARP request as it has the ARP data available in its ARP cache.</p>
</li>
<li><p class="startli">Verify the ARP offload is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the ARP offload enabled:</p>
<div class="image">
<img src="afr_arp_enable_low.png" alt="afr_arp_enable_low.png" height="500px"/>
</div>
<p class="startli">While the WLAN device (purple graph) high spikes responds to each request, the PSoC 6 host (blue graph) is in System Deep Sleep mode.</p>
</li>
</ul>
</li>
<li><p class="startli">Disable the ARP Offload feature and observe that the PSoC 6 Host wakes up on each request. Launch the ModusToolbox Device Configurator and open the appropriate design.modus file. Select the "CYW943012WKWBG" tab, select Power-&gt;Wi-Fi personality, and disable ARP offload by de-selecting the check box next to "ARP offload". Save the configuration. Then, build and program the application. With ARP offload disabled, the Host MCU (PSoC 6) will wake for every ARP request.</p>
<div class="image">
<img src="afr_arp_disable_low.png" alt="afr_arp_disable_low.png" height="500px"/>
</div>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_packet_filter"></a>
Wi-Fi Packet Filter Offload</h2>
<p>Packet filters allow the host processor to limit which types of packets get passed up to the host processor from the WLAN subsystem. This is useful to keep out unwanted / unneeded packets from the network that might otherwise wake the host out of a power-saving System Deep Sleep mode or prevent it from entering System Deep Sleep mode.</p>
<p>Packet filters are useful when:</p><ul>
<li>Trying to keep the host processor in System Deep Sleep for as long as possible.</li>
<li>Trying to get the host processor into System Deep Sleep as soon as possible.</li>
</ul>
<p>Whenever a WLAN packet is destined for the host, the WLAN processor must awaken the host (if it is asleep) so it can retrieve the packet for processing. Often times the host network stack processes the packet only to discover that the packet should be thrown away, because it is not needed. For example, it is destined for a port or service that is being used. Packet filters allow these types of packets to be filtered and discarded by the WLAN processor so the host is not interrupted.</p>
<h3><a class="anchor" id="group_lpa_p2_filtertypes"></a>
Filter Types</h3>
<p>The following types of packet filters are supported, based on a standard IP Stack:</p>
<div class="image">
<img src="PacketFiletr.png" alt="PacketFiletr.png" height="200px"/>
</div>
<p>A general purpose STA might want these types of packets:</p><ul>
<li>Ether type ARP</li>
<li>IP protocol ICMP</li>
<li>TCP port 22 (ssh)</li>
<li>UDP port 68 (DHCP)</li>
</ul>
<p>Other packet types are highly dependent on what applications and data types are in use. Multiple filters may be configured to operate simultaneously.</p>
<p><b>Network Layer / Ether Types</b></p>
<p>The EtherType filter is based on a 16-bit ethertype field present in ethernet packets, and it is the lowest level of the TC/IP stack. A technical description and list of choices can be found in numerous places, such as <a href="https://en.wikipedia.org/wiki/EtherType"><b>Ether Type</b></a>.</p>
<p>The most commonly used protocols (and most useful filters) are:</p><ul>
<li>IP (value 0x800)</li>
<li>ARP (value 0x806).</li>
</ul>
<p>Filtering on IP would match any and all IP packets coming from the network. This is a very coarsely grained filter and it will include all ICMP, TCP, and UDP packets as shown in the diagram above. Filtering on ARP is finer grained, and it will only match on ARP packets. Filtering all IP will have an enormous impact due to the large number of packets it will match and is generally not recommended for general usage.</p>
<p>Valid EtherType filters consist of a 16-bit number greater than or equal to 0x800.</p>
<p><b>Transport Layer / IP Protocols</b></p>
<p>The next layer up the stack is the Transport layer, which consists of various IP protocols such as TCP, UDP, and ICMP. Discussions of the protocols themselves are outside the realm of this document, but are widely available. A list of protocol numbers is also widely available, including: <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers"><b>IP Protocol Numbers</b></a>.</p>
<p>IP Protocol filters consist of a single 8-bit number. No checking is done to see if this number matches a well-known protocol since it is possible for vendors to use proprietary numbers and protocols.</p>
<p>Filtering on one IP protocol will only match that protocol. For example, filtering on UDP would match a UDP packet, but not ICMP or TCP packets. However, matching on TCP is still very coarsely grained and will likely include the majority of packets destined for the host processor (depending on your environment). Port numbers are the next level of filter refinement.</p>
<p><b>Applications Layer / TCP &amp; UDP Port Numbers</b></p>
<p>The applications layer distinguishes between various applications based on Port numbers. These are simply well-known numbers used to identify various TCP and UDP based applications. Technical discussions about port numbers and list of numbers that belong to which applications can be found widely on the internet, for example: <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers"><b>TCP and UDP Port Numbers</b></a>.</p>
<p>Port filters are 16-bit port numbers as described above. With a port number filter, you can filter on, for example, only ssh packets (port 22), only on ftp packets (port 20), or any other of the many applications listed above.</p>
<p>Due to the large number and constantly changing port definitions, the OLM makes no attempt to sanity check these values.</p>
<p>IP packets have both source and destination ports. Destination ports are the well-known port numbers described in the link above and generally the most useful. Source ports describe the temporary, ephemeral port numbers used by the host sending the packets. These are generated on the fly and not well known. Since they are not known ahead of time, creating a filter for them is difficult. Port ranges can be used to match a wide range of source ports to cover this case.</p>
<p>Port filters support optional port ranges. A port range describes a start and end such that any port number within that start-end range will match. This is most useful for matching a short-lived ephemeral source port number since it will not be known ahead of time.</p>
<p>Since both TCP and UDP use port numbers, filters are configured to match one or the other (TCP or UDP). If both TCP and UDP need to be filtered for a particular port, two filters can be created; one for each.</p>
<h3><a class="anchor" id="group_lpa_p2_keeptoss"></a>
Action (Keep vs Toss)</h3>
<p>Filters can be configured to either Keep (send to host) or Toss (drop / discard). When configured to drop, only the specified packets are dropped, while any others not specifically filtered are passed to the host. Likewise, when configured to keep packets, only the specified packets are passed to the host and the rest discarded. The most helpful model is to use only 'keep' filters. In other words, use 'keep' filters to specify the complete list of packet types the host is interested in, and discard the rest. This works because (usually) it is much simpler to list the packets the host wants to receive versus creating a complete list of packets it doesn't want.</p>
<p>When using keep filters, use care to allow enough packets through for networking protocols to work properly. For instance, the processor must be able to join a network, get a DHCP address, respond to ARP requests, and possibly share network keys. Not creating enough keep filters to allow all these type of packets through will prevent the host from joining the network. A reasonable minimal set of keep filters includes:</p><ul>
<li>Keep, EtherType 0x806 #Allow ARP through</li>
<li>Keep, EtherType 0x888e #Allow security packets through</li>
<li>Keep, Port Filter: UDP Dest Port 68 #Allow DHCP packets through.</li>
</ul>
<p>These additional filters might also be needed depending on your application:</p><ul>
<li>Keep, Port Filter: UDP, Source Port 53 #Allow DNS packet (use source port)</li>
<li>Keep, Port Filter: TCP Dest Port 8883 #Allow Secure MQTT packets</li>
<li>Keep, Port Filter: TCP Dest Port 1883 #Allow Open MQTT packets</li>
</ul>
<p>These 'keep' filters will keep only the packet types as described; all other traffic will be discarded so it is critical to use enough filters to allow your application to receive the traffic it needs. This type of configuration is useful when your system receives many different kinds of traffic and it is easier to describe the traffic to be kept rather than the traffic to be discarded.</p>
<p>Alternatively, it is often simpler to describe the specific type of traffic to be discarded and keeping everything else. For example, someone on the network keeps pinging your machine (using ICMP packets) and waking it. You'd like to block ICMP and keep everything else. In this case, just one filter is needed:</p><ul>
<li>Discard, IPType 1 # toss ICMP packet</li>
</ul>
<p>This will discard all incoming ping/ICMP packets and keep all other traffic.</p>
<p>There are no minimal filters for toss filters because the system will filter the specific packets and everything else gets passed up to the host.</p>
<p><b>Note</b> All active filters need to be of the same type (keep or toss). Mixing active keep and toss filters will cause unexpected behaviors.</p>
<p>Below diagram shows packet filter offload with ICMP packet configured to be discarded</p>
<div class="image">
<img src="pf_ping_packet_discard.png" alt="pf_ping_packet_discard.png" height="500px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_sleepwake"></a>
When Active (Sleep vs Wake)</h3>
<p>Filters can be configured to be active either when the host processor is active or asleep, or both. When a filter is not active, it has no effect. When the system goes into sleep mode, it disables all wake filters and enables all sleep filters just before entering sleep. When waking, all sleep filters are disabled and wake filters enabled.</p><ul>
<li>Wake filters allow the host to go into sleep mode faster.</li>
<li>Sleep filters help the host stay asleep longer.</li>
</ul>
<p>Normally, without packet filters, the WLAN subsystem passes all packets destined for the host up to the host network stack for processing. If the host is in System Deep Sleep, the WLAN subsystem will first wake the host and then pass the packet up to the stack. From there, the network stack will pass the packet on to the application that is listening for that type of packet. If no applications are listening for that type of packet, the network stack drops the packet.</p>
<p>For instance:</p><ul>
<li>An http packet arrives on port 80, but there is no http server running that would read the packet (port 80 is default http port).</li>
<li>An ssh packet arrives on port 22, but there is no ssh server running that would read that packet (port 22 is default ssh port).</li>
</ul>
<p>In both cases, the host would awake from its battery saving System Deep Sleep just to drop a packet. It is not hard to imagine scenarios where traffic your application doesn't want or doesn't care about ends up penalizing your battery usage by constantly waking the host from System Deep Sleep. Alternatively, these unwanted packets can also prevent the host from entering System Deep Sleep in the first place. The host has an idle sleep threshold. When the host has been idle longer than that threshold, it will put itself to sleep. Processing unwanted packets (even just dropping them) will cause the host to come out of idle and prevent it from reaching the idle sleep threshold, preventing the host from entering sleep. In both cases, traffic patterns keep the processor awake, burning power.</p>
<h3><a class="anchor" id="group_lpa_p2_packet_filter_qsg"></a>
Quick Start Guide</h3>
<p>This Quick Start Guide demonstrates of how to configure and use the Packet Filter feature in the Mbed OS/ FreeRTOS environment and its impact on the system power consumption.</p>
<h4><a class="anchor" id="group_lpa_p2_pf_offload_qsg_mbedos"></a>
MBEDOS</h4>
<p>The mbed-os-example-wifi is used as a base for this guide on the CY8CKIT_062S2_43012 pioneer kit. This section assumes that a user has an Mbed OS development environment configured. Refer to <a href="https://os.mbed.com/getting-started/">https://os.mbed.com/getting-started/</a> to setup Mbed OS develop environment.</p>
<p>The following steps are required to setup the mbed-os-example-wifi example with enabling the Packet Filter feature:</p>
<ol type="1">
<li>Import the mbed-os-example-wifi example project and switch to the example directory: <div class="fragment"><div class="line">mbed <span class="keyword">import</span> mbed-os-example-wifi</div><div class="line">cd mbed-os-example-wifi</div></div><!-- fragment --></li>
<li>Execute the following command in order to replace Mbed OS, download the LPA middleware and connectivity utilities: <div class="fragment"><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/lpa/</span></div><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/connectivity-utilities/</span></div><div class="line">mbed deploy</div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters:<ul>
<li>Modify mbed_app.json to update "wifi-ssid" and "wifi-password" values as desired: <div class="fragment"><div class="line">...</div><div class="line">    <span class="stringliteral">&quot;wifi-ssid&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi SSID&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;SSID\&quot;&quot;</span></div><div class="line">    },</div><div class="line">    <span class="stringliteral">&quot;wifi-password&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi Password&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;PASSWORD\&quot;&quot;</span></div><div class="line">    }</div><div class="line">...</div></div><!-- fragment --><ul>
<li>Add "MBED" Component to mbed_app.json in target_overrides section which is required for compiling helpers in LPA code <br />
 "target.components_add": ["MBED"] <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;MBED&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Optional: modify main.cpp to update Wi-Fi security settings: <div class="fragment"><div class="line"><span class="keywordtype">int</span> ret = wifi-&gt;connect(MBED_CONF_APP_WIFI_SSID, MBED_CONF_APP_WIFI_PASSWORD, NSAPI_SECURITY_WPA_WPA2);</div></div><!-- fragment --> Modify the last parameter if needed to either: <div class="fragment"><div class="line">NSAPI_SECURITY_NONE</div><div class="line">NSAPI_SECURITY_WEP</div><div class="line">NSAPI_SECURITY_WPA</div><div class="line">NSAPI_SECURITY_WPA2</div><div class="line">NSAPI_SECURITY_WPA_WPA2</div><div class="line">NSAPI_SECURITY_WPA3</div></div><!-- fragment --></li>
</ul>
</li>
<li>Modify main.cpp to go to deep-sleep after connecting to the Wi-Fi Access Point. MBED uses LWIP as the network stack. LWIP has periodic timers (smallest timer ~100ms), which wake up the Host MCU periodically. Do the following to suspend these timers, so the Host MCU can be in deep-sleep for a longer time. This is needed to demonstrate / verify Packet Filter(s) are not waking up the Host MCU.<ul>
<li>Include WhdSTAInterface.h and network_activity_handler.h: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;WhdSTAInterface.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;network_activity_handler.h&quot;</span></div></div><!-- fragment --></li>
<li>Add the following declarations: <div class="fragment"><div class="line"><span class="comment">// This macro specifies the interval in milliseconds that the device monitors</span></div><div class="line"><span class="comment">// the network for inactivity. If the network is inactive for duration lesser</span></div><div class="line"><span class="comment">// than INACTIVE_WINDOW_MS in this interval, the MCU does not suspend the network</span></div><div class="line"><span class="comment">// stack and informs the calling function that the MCU wait period timed out</span></div><div class="line"><span class="comment">// while waiting for network to become inactive.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_INTERVAL_MS    (300u)</span></div><div class="line"></div><div class="line"><span class="comment">// This macro specifies the continuous duration in milliseconds for which the</span></div><div class="line"><span class="comment">// network has to be inactive. If the network is inactive for this duration, the</span></div><div class="line"><span class="comment">// MCU will suspend the network stack. Now, the MCU will not need to service the</span></div><div class="line"><span class="comment">// network timers which allows it to stay longer in sleep/deepsleep.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define INACTIVE_WINDOW_MS      (200u)</span></div></div><!-- fragment --></li>
<li>Modify main.cpp to allow the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. For this, replace the line "wifi-&gt;disconnect();" with the following code: <div class="fragment"><div class="line"><span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div><div class="line">    <a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(static_cast&lt;WhdSTAInterface*&gt;(wifi),</div><div class="line">       osWaitForever, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
<li>Configure Packet Filters, the preferred way to is to use ModusToolbox IDE.<ul>
<li>Mandatory steps to avoid design.modus file modification in mbed-os folder<ol type="a">
<li>Copy folder mbed-os-example-wifi/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-wifi folder</li>
<li>Delete all files in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-wifi folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS) <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ol>
</li>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Disable ARP offload.</li>
<li>Enable "Add minimal set of keep filters", these filters allow ARP, DNS, DHCP and 802.1x security packets to wake up the Host, and are needed to connect to WiFi Access point, any other WiFi packets are dropped by WLAN chip and not forwarded to the Host MCU (PSoC6)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS -DMBED_CPU_STATS_ENABLED --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash --sterm</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
<p class="startli">MBED_CPU_STATS_ENABLED : This helps to understand how much time MCU remained in sleep state</p>
<p class="startli">When the modified mbed-os-example-wifi starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">Scan:</div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Oct 29 2019 22:00:20 version 13.10.271.215 (r723093) FWID 01-f268ebc9</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2019-10-29 21:50:17</div><div class="line">WHD VERSION      : v1.50.0-rc1 : v1.50.0-rc1 : GCC 7.3 : 2019-10-30 18:42:31 +0530</div><div class="line">Network: airport_5g secured: WPA2 BSSID: 24:A2:E1:f0:50:25 RSSI: -84 Ch: 36</div><div class="line">Network: Broadcom secured: None BSSID: 0:10:18:ee:b5:f7 RSSI: -52 Ch: 36</div><div class="line">Network: test_2nd_cy secured: WPA2 BSSID: F8:32:E4:b0:ff:8c RSSI: -74 Ch: 36</div><div class="line">Network: eero secured: WPA2 BSSID: F8:BB:BF:b2:2:54 RSSI: -33 Ch: 36</div><div class="line">Network: WWD secured: WPA/WPA2 BSSID: 64:A5:C3:64:16:13 RSSI: -77 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:b1:74:b4 RSSI: -36 Ch: 36</div><div class="line">Network: eero secured: WPA/WPA2 BSSID: F8:BB:BF:69:2b:8 RSSI: -46 Ch: 36</div><div class="line">Network: prke-bsh5g secured: WPA/WPA2 BSSID: 44:4E:6D:45:b0:58 RSSI: -82 Ch: 36</div><div class="line">Network:  secured: Unknown BSSID: F8:BB:BF:b2:2:52 RSSI: -33 Ch: 36</div><div class="line">Network: testap secured: None BSSID: 0:A0:50:30:81:65 RSSI: -64 Ch: 36</div><div class="line">Network: RW1 secured: WPA2 BSSID: C8:8:73:3c:87:2c RSSI: -75 Ch: 40</div><div class="line">Network: CYFI secured: WPA2 BSSID: B0:B8:67:3b:ac:70 RSSI: -86 Ch: 44</div><div class="line">Network: CYFI secured: WPA2 BSSID: 80:8D:B7:69:77:30 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_GUEST secured: None BSSID: 80:8D:B7:69:77:31 RSSI: -70 Ch: 44</div><div class="line">Network: CYFI_ZOOM secured: WPA2 BSSID: 80:8D:B7:69:77:32 RSSI: -70 Ch: 44</div><div class="line">15 networks available.</div><div class="line"></div><div class="line">Connecting to SSID...</div><div class="line">Success</div><div class="line"></div><div class="line">MAC: d4:4d:a4:a0:02:a4</div><div class="line">IP: 192.168.1.12</div><div class="line">Netmask: 255.255.255.0</div><div class="line">Gateway: 192.168.1.1</div><div class="line">RSSI: -29</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send "ping" command to the board and observe in serial terminal that it does not wake up the PSoC 6 device since there is no "keep" packet filter for ICMP pings, there is no response for the pings: <div class="fragment"><div class="line">C:\&gt;ping 192.168.1.12</div><div class="line"> </div><div class="line">Pinging 192.168.1.12 with 32 bytes of data:</div><div class="line">Request timed out.</div><div class="line">Request timed out.</div><div class="line"> </div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.1.12:</div><div class="line">    Packets: Sent = 2, Received = 0, Lost = 2 (100% loss),</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address] <div class="fragment"><div class="line">C:\&gt;arp-ping.exe 192.168.1.12</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1127.934ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1116.976ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1124.160ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.1.12 in 1119.439ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.1.12/arp</div><div class="line">  4 probes sent.</div><div class="line">  4 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">  Minimum = 1116.976ms, Maximum = 1127.934ms, Average = 1122.127ms</div></div><!-- fragment --></li>
</ul>
<p class="startli">Observe that PSoC 6 MCU wakes up for each command since there is "keep" packet filter for ARP pings, the ARP pings are responded back: </p><div class="fragment"><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 396ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:51, rx_total:405, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:4525, cmd53_read:3086, cmd53_write:1064</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:611, sdio_intrs:2067, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Verify the packet Filter is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the Packet Filter enabled</p>
<p class="startli">i. ARP Ping : This wakes up the host as packet filter for ARP is configured</p>
<div class="image">
<img src="packet_filter_arp_ping.png" alt="packet_filter_arp_ping.png" height="500px"/>
</div>
<p class="startli">ii. Ping : This doesnot wakeup the host as ICMP packet is not configured as packet filter type </p><div class="image">
<img src="packet_filter_ping.png" alt="packet_filter_ping.png" height="500px"/>
</div>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_pf_offload_qsg_anycloud"></a>
FREERTOS</h4>
<p>The following steps are required to setup the wifi-low-power example with enabling the Packet Filter feature:</p>
<ol type="1">
<li>Checkout Wi-Fi Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-anycloud-wlan-lowpower.git</span></div><div class="line">cd mtb-example-anycloud-wlan-lowpower</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Add lib file for TARGET_CY8CKIT-062S2-43012 in deps folder and delete deps/TARGET_CY8CPROTO-062-4343W.lib <div class="fragment"><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach , make sure below mtb files are present</span></div><div class="line"><span class="preprocessor">echo https://github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in lowpower_task.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     CY_WCM_SECURITY_WPA2_MIXED_PSK</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in lowpower_task.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Configure Packet Filters, the preferred way to is to use ModusToolbox IDE.<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mtb-example-anycloud-wlan-lowpower/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mtb-example-anycloud-wlan-lowpower/libs/psoc6pdl/devicesupport.xml (For MTB2.2, point to mtb_shared/mtb-pdl-cat1/&lt;&gt;/devicesupport.xml) file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Disable ARP offload.</li>
<li>Enable "Add minimal set of keep filters", these filters allow ARP, DNS, DHCP and 802.1x security packets to wake up the Host, and are needed to connect to WiFi Access point, any other WiFi packets are dropped by WLAN chip and not forwarded to the Host MCU (PSoC6)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --><p class="startli">When the modified mtb-example-anycloud-wlan-lowpower starts, the console output shows that it connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">=======================================================</div><div class="line">CE230106 - Example: WLAN Lowpower</div><div class="line">=======================================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div><div class="line">Info:Connecting to AP</div><div class="line">IP Address 10.0.0.201 assigned</div><div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div><div class="line">Info:Beacon period = 100, DTIM period = 3</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send "ping" command to the board and observe in serial terminal that it does not wake up the PSoC 6 MCU since there is no "keep" packet filter for ICMP pings, there is no response for the pings: <div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div><div class="line"></div><div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div><div class="line">Request timed out.</div><div class="line">Request timed out.</div><div class="line">Request timed out.</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div><div class="line">    Packets: Sent = 3, Received = 0, Lost = 3 (100% loss),</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address] <div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 10.0.0.201</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 113.209ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 125.789ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1114.333ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201/arp</div><div class="line">    3 probes sent.</div><div class="line">    3 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">    Minimum = 113.209ms, Maximum = 1114.333ms, Average = 451.111ms</div></div><!-- fragment --></li>
</ul>
<p class="startli">Observe that PSoC 6 MCU wakes up for each command since there is "keep" packet filter for ARP pings, the ARP pings are responded back: </p><div class="fragment"><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Verify the packet Filter is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the Packet Filter enabled</p>
<p class="startli">i. ARP Ping : This wakes up the host as packet filter for ARP is configured</p>
<div class="image">
<img src="FreeRTOS_PF_ARP_ping.png" alt="FreeRTOS_PF_ARP_ping.png" height="500px"/>
</div>
<p class="startli">ii. Ping : This doesnot wakeup the host as ICMP packet is not configured as packet filter type </p><div class="image">
<img src="FreeRTOS_PF_ping_nowake.png" alt="FreeRTOS_PF_ping_nowake.png" height="500px"/>
</div>
</li>
</ol>
<h4><a class="anchor" id="group_lpa_p2_pf_offload_qsg_afr"></a>
AFR</h4>
<p>The following steps are required to setup the afr-example-wlan-offloads example with enabling the Packet Filter feature:</p>
<ol type="1">
<li>Checkout Wi-Fi Low Offloads Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/projects/cypress/</div><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/afr-example-wlan-offloads.git</span></div><div class="line">cd afr-example-wlan-offloads</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in wifi_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     eWiFiSecurityWPA2</span></div></div><!-- fragment --></li>
<li>Modify below macro in wlan_offload.h to use offload configurations from ModusToolbox Device Configurator <div class="fragment"><div class="line"><span class="preprocessor">#define USE_CONFIGURATOR_GENERATED_CONFIG    (1)</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in wlan_offload.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li>Configure Packet Filters, the preferred way to is to use ModusToolbox IDE.<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the amazon-freertos/vendors/cypress/psoc6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Disable ARP offload.</li>
<li>Enable "Add minimal set of keep filters", these filters allow ARP, DNS, DHCP and 802.1x security packets to wake up the Host, and are needed to connect to WiFi Access point, any other WiFi packets are dropped by WLAN chip and not forwarded to the Host MCU (PSoC6)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">cmake -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=../../../tools/cmake/toolchains/arm-gcc.cmake</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p class="startli"><b> Make </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Program the board with afr-example-wlan-offloads.elf file generated under below folder using <a href="https://www.cypress.com/products/psoc-programming-solutions"><b> Cypress Programmer </b></a> <br />
 CMake : <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/build/</em> <br />
 Make : <em>amazon-freertos/build/cy/afr-example-wlan-offloads/CY8CKIT-062S2-43012/Debug</em> <br />
 <pre class="fragment">When the modified afr-example-wlan-offloads starts, the console output 
shows that it connects to the specified 
above Wi-Fi Access Point, and then the PSoC 6 MCU goes to 
System Deep Sleep.
</pre> <div class="fragment"><div class="line">Info: ==================================</div><div class="line">Info: AFR Example: WLAN Offloads</div><div class="line">Info: ==================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.90.2 : v1.90.2 : GCC 9.2 : 2020-04-13 02:49:57 -0500</div><div class="line">Info: --Offload Manager is initialized with the device configurator generated configuration--</div><div class="line">Info: Wi-Fi module initialized. Connecting to AP...</div><div class="line">Info: Wi-Fi connected to AP: SSID</div><div class="line">Info: IP Address acquired: 192.168.43.11</div><div class="line">Error: Unable to find TKO offloads configuration</div><div class="line">Error: tcp_socket_connection_start: Offload descriptor TKO not found. No TCP connection has been established.</div><div class="line">Check the TCP Keepalive offload settings in ModusToolbox Device Configurator tool</div><div class="line">Error: One or more TCP socket connections failed.</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 27547ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:81, rx_total:80, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2339, cmd53_read:402, cmd53_write:583</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:79, sdio_intrs:167, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mo</div></div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board.<ul>
<li>Send "ping" command to the board and observe in serial terminal that it does not wake up the PSoC 6 device since there is no "keep" packet filter for ICMP pings, there is no response for the pings: <div class="fragment"><div class="line">C:\&gt;ping 192.168.43.11 -n 3</div><div class="line"></div><div class="line">Pinging 192.168.43.11 with 32 bytes of data:</div><div class="line">Request timed out.</div><div class="line">Request timed out.</div><div class="line">Request timed out.</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.43.11:</div><div class="line"> Packets: Sent = 3, Received = 0, Lost = 3 (100% loss),</div></div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC 6 MCU is in Deep Sleep mode. Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address] <div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 192.168.43.11</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 1113.866ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 1113.747ms</div><div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.43.11 in 1113.806ms</div><div class="line"></div><div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.43.11/arp</div><div class="line">  3 probes sent.</div><div class="line">     3 successful, 0 failed.</div><div class="line">Approximate trip times in milli-seconds:</div><div class="line">     Minimum = 1113.747ms, Maximum = 1113.866ms, Average = 1113.806ms</div></div><!-- fragment --></li>
</ul>
<p class="startli">Observe that PSoC 6 MCU wakes up for each command since there is "keep" packet filter for ARP pings, the ARP pings are responded back: </p><div class="fragment"><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div><div class="line"></div><div class="line">=====================================================</div><div class="line">WHD Stats..</div><div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div><div class="line">tx_fail:0, no_credit:0, flow_control:0</div><div class="line">Bus Stats..</div><div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div><div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div><div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div><div class="line">=====================================================</div><div class="line">Network is active. Resuming network stack</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Verify the packet Filter is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the Packet Filter enabled</p>
<p class="startli">i. ARP Ping : This wakes up the host as packet filter for ARP is configured</p>
<div class="image">
<img src="afr_pf_arpping_wake_low.png" alt="afr_pf_arpping_wake_low.png" height="500px"/>
</div>
<p class="startli">ii. Ping : This doesnot wakeup the host as ICMP packet is not configured as packet filter type </p><div class="image">
<img src="afr_pf_ping_sleep_low.png" alt="afr_pf_ping_sleep_low.png" height="500px"/>
</div>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_tcp_keepalive"></a>
Wi-Fi TCP Keep Alive Offload</h2>
<p>TCP Keepalive Offload part of the Low Power Assistant is designed to improve the power consumption of your connected system by reducing the time the Host needs to stay awake to support TCP Keepalive Request. This document describes how to enable TCP Keep alive Offload and configure 4 different sockets for TCP keepalive that can be incorporated into your project from <a href="https://github.com/cypresssemiconductorco/lpa"><b>Cypress GitHub LPA Middleware</b></a>.</p>
<p>TCP Keepalive maintains idle TCP connections by periodically passing packets between the client and server. If either the client or server does not respond to a packet, the connection is considered inactive and is terminated. This helps in pruning dead connections. Typically TCP Keepalives are sent every 45 or 60 seconds on an idle TCP connection, and the connection is dropped after 3 sequential ACKs are missed. This means Host MCU has to wake up periodically to send TCP Keepalive packet to maintain TCP connection during idle state.</p>
<p>TCP Keepalive Offload helps in moving this functionality to WLAN firmware so that Host MCU doesnot need to wake up periodically to send/receive TCP Keepalive packets. This functionality is offloaded only when Host MCU goes to sleep and network stack is suspended</p>
<div class="image">
<img src="TCP_Keepalive_basic_graph.png" alt="TCP_Keepalive_basic_graph.png" height="500px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_tcp_keepalive_qsg"></a>
Quick Start Guide</h3>
<p>This Quick Start Guide demonstrates of how to configure and use the TCP Keep alive offload feature in the Mbed OS &amp; FreeRTOS environment and its impact on the system power consumption.</p>
<h4><a class="anchor" id="group_lpa_p2_tcp_keepalive_qsg_mbedos"></a>
MBEDOS</h4>
<p>The mbed-os-example-wifi is used as a base for this guide on the CY8CKIT_062S2_43012 pioneer kit. This section assumes that you have an Mbed OS development environment configured. Refer to <a href="https://os.mbed.com/getting-started/">https://os.mbed.com/getting-started/</a> for instructions about how to do that.</p>
<p>The following steps are required to set up the mbed-os-example-wifi example and enable the TCP Keepalive offload feature:</p>
<ol type="1">
<li>Import the mbed-os-example-wifi example project and switch to the example directory: <div class="fragment"><div class="line">mbed <span class="keyword">import</span> mbed-os-example-wifi</div><div class="line">cd mbed-os-example-wifi</div></div><!-- fragment --></li>
<li>Execute the following command in order to replace Mbed OS, download the LPA middleware and connectivity utilities: <div class="fragment"><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/lpa/</span></div><div class="line">mbed add https:<span class="comment">//github.com/cypresssemiconductorco/connectivity-utilities/</span></div><div class="line">mbed deploy</div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters:<ul>
<li>Modify mbed_app.json to update "wifi-ssid" and "wifi-password" values as desired: <div class="fragment"><div class="line">...</div><div class="line">    <span class="stringliteral">&quot;wifi-ssid&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi SSID&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;SSID\&quot;&quot;</span></div><div class="line">    },</div><div class="line">    <span class="stringliteral">&quot;wifi-password&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;help&quot;</span>: <span class="stringliteral">&quot;WiFi Password&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;value&quot;</span>: <span class="stringliteral">&quot;\&quot;PASSWORD\&quot;&quot;</span></div><div class="line">    }</div><div class="line">...</div></div><!-- fragment --><ul>
<li>Add "MBED" Component to mbed_app.json in target_overrides section which is required for compiling helpers in LPA code <br />
 "target.components_add": ["MBED"] <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;MBED&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
</li>
</ul>
</li>
<li>Replace main.cpp with this (<a href="main.txt" rel="stylesheet" type="text/css"><b>main.txt</b></a>) which is configuring TCP Keepalive offload based on the configurator parameters (Copy main.txt as main.cpp)<ul>
<li>Optional: modify main.cpp to update Wi-Fi security settings: <div class="fragment"><div class="line"><span class="keywordtype">int</span> ret = wifi-&gt;connect(MBED_CONF_APP_WIFI_SSID, MBED_CONF_APP_WIFI_PASSWORD, NSAPI_SECURITY_WPA_WPA2);</div></div><!-- fragment --> Modify the last parameter if needed to either: <div class="fragment"><div class="line">NSAPI_SECURITY_NONE</div><div class="line">NSAPI_SECURITY_WEP</div><div class="line">NSAPI_SECURITY_WPA</div><div class="line">NSAPI_SECURITY_WPA2</div><div class="line">NSAPI_SECURITY_WPA_WPA2</div><div class="line">NSAPI_SECURITY_WPA3</div></div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Configure the TCP Keepalive offload. There are two ways to configure the TCP keep-alive offload one via Device configurator and other via Manual Configuration</p>
<p class="startli">i. The easiest way to configure TCP Keepalive offload is to use the ModusToolbox Device Configurator.</p><ul>
<li>Mandatory steps to avoid design.modus file modification in mbed-os folder<ol type="a">
<li>Copy folder mbed-os-example-wifi/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-wifi folder</li>
<li>Delete all files in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-wifi folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS) <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">         <span class="stringliteral">&quot;*&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;platform.stdio-convert-newlines&quot;</span>: <span class="keyword">true</span>,</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ol>
</li>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mbed-os-example-wifi/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable TCP Keep Alive Offload.</li>
<li>Configure Interval, Retry Interval, Retry Count</li>
<li>Configure Source port, Destination port, Destination IP address (TCP server)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
<p class="startli">ii. The manual configuration Steps</p><ul>
<li>Read the OLM configuration from device configurator and make a copy of OLM device configurator <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_6">Code Snippet 6: Read OLM configuration from device configurator.</a></li>
<li>search for "TKO" name in the device configurator list, if present then use it establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>If TCP Keep-alive offload is not present in device configurator then add TCP keep-alive offload list <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_3">Code Snippet 3: Search for TCP KA offload in the device configurator list.</a></li>
<li>call the API to restart olm <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_4">Code Snippet 4: Use cylpa_restart_olm when the OLM configuration is changed by the user application.</a></li>
<li>Establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>TCP keep-alive offload will be enabled when host MCU goes to sleep <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_1">Code Snippet 1: Using wait_net_suspend for suspend/resume network stack</a></li>
<li><b>Note</b> The maximum supported TCP connections that can be offloaded to WLAN device is 4 (MAX_TKO) this is WLAN firmware limitation, if the API <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a> is invoked more than 4 times then LIFO ( Last In First Out) Algorithm is followed where the MRU(Most Recently Used) TCP connections will only be offloaded to WLAN device.</li>
</ul>
</li>
<li>Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board. Run <a href="tcp_echo_server.py" rel="stylesheet" type="text/css"><b>tcp_echo_server.py</b></a> in that PC to act as TCP Server. This script works only for Python version 2.7 <div class="fragment"><div class="line">python tcp_echo_server.py --port 3360</div></div><!-- fragment --></li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS -DMBED_CPU_STATS_ENABLED --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash --sterm</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
<p class="startli">MBED_CPU_STATS_ENABLED : This helps to understand how much time MCU remained in sleep state</p>
<p class="startli">When the modified mbed-os-example-wifi starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, connects to TCP server using the configurator settings and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">Scan:</div><div class="line">WLAN MAC Address : DC:EF:CA:00:36:3B</div><div class="line">WLAN Firmware    : wl0: Sep  5 2019 23:24:33 version 7.45.98.92 (r722362 CY) FWID 01-f7128517</div><div class="line">WLAN CLM         : API: 12.2 Data: 9.10.39 Compiler: 1.29.4 ClmImport: 1.36.3 Creation: 2019-09-05 23:10:00</div><div class="line">WHD VERSION      : v1.50.0-rc1 : v1.50.0-rc1 : GCC 7.3 : 2019-10-30 18:42:31 +0530</div><div class="line">Network: eero secured: WPA2 BSSID: F8:BB:BF:b1:74:b3 RSSI: -67 Ch: 1</div><div class="line">Network: eero secured: WPA2 BSSID: F8:BB:BF:69:2b:6 RSSI: -65 Ch: 1</div><div class="line">Network:  secured: None BSSID: F8:BB:BF:b2:2:55 RSSI: -71 Ch: 1</div><div class="line">Network:  secured: Unknown BSSID: F8:BB:BF:b2:2:51 RSSI: -72 Ch: 1</div><div class="line">Network: eero secured: Unknown BSSID: F8:BB:BF:b2:2:53 RSSI: -69 Ch: 1</div><div class="line">Network: TPUT2G secured: None BSSID: A0:63:91:d1:45:55 RSSI: -85 Ch: 1</div><div class="line">Network: SilverFox secured: WPA2 BSSID: AC:22:B:ce:f9:10 RSSI: -41 Ch: 1</div><div class="line">Network: ape secured: WPA2 BSSID: 24:A2:E1:f0:50:24 RSSI: -84 Ch: 1</div><div class="line">Network: 2GAP secured: None BSSID: 0:90:4C:12:d2:7 RSSI: -90 Ch: 1</div><div class="line">Network: test_2nd_cy secured: WPA2 BSSID: F8:32:E4:b0:ff:88 RSSI: -69 Ch: 1</div><div class="line">Network: r6300 secured: WPA2 BSSID: 4:A1:51:19:e:e RSSI: -70 Ch: 4</div><div class="line">Network: 1STLEE_CH6 secured: WPA2 BSSID: 0:10:18:ee:b6:ea RSSI: -69 Ch: 6</div><div class="line">Network: prasanna-acrg secured: None BSSID: 0:10:18:e2:e9:b1 RSSI: -67 Ch: 6</div><div class="line">Network: CYFI secured: Unknown BSSID: B0:B8:67:3b:27:e0 RSSI: -54 Ch: 6</div><div class="line">Network: steveo_test_2g secured: WPA2 BSSID: 84:1B:5E:e5:63:a5 RSSI: -60 Ch: 6</div><div class="line">15 networks available.</div><div class="line"></div><div class="line">Connecting to testtko...</div><div class="line">Success</div><div class="line"></div><div class="line">MAC: dc:ef:ca:00:36:3b</div><div class="line">IP: 192.168.1.16</div><div class="line">Netmask: 255.255.255.0</div><div class="line">Gateway: 192.168.1.1</div><div class="line">RSSI: -31</div><div class="line"></div><div class="line">TKO is enabled via configurator</div><div class="line">Set LWIP keepalive: Interval 20, Retry Interval 3, keepalive value 20</div><div class="line">Socket[0]: Created connection to IP 192.168.1.13, local port 3353, remote port 3360</div><div class="line">Socket[1]: ERROR -3004, Unable to connect:  IP 0.0.0.0, local port 0, remote port 0</div><div class="line">Socket[2]: ERROR -3004, Unable to connect:  IP 0.0.0.0, local port 0, remote port 0</div><div class="line">Socket[3]: ERROR -3004, Unable to connect:  IP 0.0.0.0, local port 0, remote port 0</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
</ol>
<p><b>TCP Keepalive device configurator reference:</b></p>
<div class="image">
<img src="TCPKA_deviceConfigurator.png" alt="TCPKA_deviceConfigurator.png" height="700px"/>
</div>
<p>Verify the TCP Keepalive offload is working as desired.Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with</p>
<p><b>TCP Keepalive Offload enabled with 20 seconds interval configuration:</b> </p><div class="image">
<img src="tcp_keepalive_enabled.png" alt="tcp_keepalive_enabled.png" height="500px"/>
</div>
<h4><a class="anchor" id="group_lpa_p2_tcp_keepalive_qsg_anycloud"></a>
FREERTOS</h4>
<p>The following steps are required to setup the wifi-low-power tcp keepalive offload example and enable the TCP Keepalive offload feature.</p>
<ol type="1">
<li>Checkout Wi-Fi TCP Keepalive offload Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-anycloud-offload-tcp-keepalive.git</span></div><div class="line">cd mtb-example-anycloud-offload-tcp-keepalive</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Add lib file for TARGET_CY8CKIT-062S2-43012 in deps folder and delete deps/TARGET_CY8CPROTO-062-4343W.lib <div class="fragment"><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach , make sure below mtb files are present</span></div><div class="line"><span class="preprocessor">echo https://github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in app_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     CY_WCM_SECURITY_WPA2_MIXED_PSK</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in tcp_keepalive_offload.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, NETWORK_INACTIVE_INTERVAL_MS, NETWORK_INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li><p class="startli">Configure the TCP Keepalive offload. There are two ways to configure the TCP keep-alive offload one via Device configurator and other via Manual Configuration</p>
<p class="startli">i. The easiest way to configure TCP Keepalive offload is to use the ModusToolbox Device Configurator.</p><ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>mtb-example-anycloud-offload-tcp-keepalive/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the mtb-example-anycloud-offload-tcp-keepalive/libs//psoc6pdl/devicesupport.xml (For MTB2.2, point to mtb_shared/mtb-pdl-cat1/&lt;&gt;/devicesupport.xml) file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable TCP Keep Alive Offload.</li>
<li>Configure Interval, Retry Interval, Retry Count</li>
<li>Configure Source port, Destination port, Destination IP address (TCP server)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
<p class="startli">ii. Manual configuration steps</p><ul>
<li>Read the OLM configuration from device configurator and make a copy of OLM device configurator <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_2">Code Snippet 2: Read OLM configuration from device configurator.</a></li>
<li>search for "TKO" name in the device configurator list, if present then use it establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>If TCP Keep-alive offload is not present in device configurator then add TCP keep-alive offload list <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_3">Code Snippet 3: Search for TCP KA offload in the device configurator list.</a></li>
<li>call the API to restart olm <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_4">Code Snippet 4: Use cylpa_restart_olm when the OLM configuration is changed by the user application.</a></li>
<li>Establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>TCP keep-alive offload will be enabled when host MCU goes to sleep <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_1">Code Snippet 1: Using wait_net_suspend for suspend/resume network stack</a></li>
<li><b>Note</b> The maximum supported TCP connections that can be offloaded to WLAN device is 4 (MAX_TKO) this is WLAN firmware limitation, if the API <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a> is invoked more than 4 times then LIFO ( Last In First Out) Algorithm is followed where the MRU(Most Recently Used) TCP connections will only be offloaded to WLAN device.</li>
</ul>
</li>
<li>Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board. Run <a href="tcp_echo_server.py" rel="stylesheet" type="text/css"><b>tcp_echo_server.py</b></a> in that PC to act as TCP Server <div class="fragment"><div class="line">python tcp_echo_server.py --port 3360</div></div><!-- fragment --></li>
<li><p class="startli">Build the project and program the board. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --><p class="startli">When the modified mtb-example-connectivity-offload-tcp-keepalive starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. </p><div class="fragment"><div class="line">Info: ============================================</div><div class="line">Info:  Example: WLAN TCP Keepalive Offload</div><div class="line">Info: ============================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div><div class="line">Wi-Fi initialization is successful</div><div class="line">Join to AP: SSID</div><div class="line">IP Address 192.168.43.11 assigned</div><div class="line">Successfully joined wifi network SSID</div><div class="line">Taking TCP Keepalive configuration from the Generated sources.</div><div class="line">TCP remote IP Address f2ba8c0  remote port:3360</div><div class="line">TCP Connection Established Successfully ctx:8011050</div><div class="line">Socket[0]: Created connection to IP 192.168.43.15, local port 3353, remote port 3360</div><div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[1]. Check the TCP Keepalive configuration.</div><div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[2]. Check the TCP Keepalive configuration.</div><div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[3]. Check the TCP Keepalive configuration.</div><div class="line">Low power task created</div><div class="line">whd_tko_toggle: Successfully enabled</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Verify the TCP Keepalive offload is working as desired.Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions.The following oscilloscope screen capture shows current measurement with</li>
</ol>
<p><b>TCP Keepalive Offload enabled with 20 seconds interval configuration and WLAN DTIM configured as 3 :</b> </p><div class="image">
<img src="FreeRTOS_TKO_Enable.png" alt="FreeRTOS_TKO_Enable.png" height="500px"/>
</div>
<h4><a class="anchor" id="group_lpa_p2_tcp_keepalive_qsg_afr"></a>
AFR</h4>
<p>The following steps are required to setup the afr-example-wlan-offloads example and enable the TCP Keepalive offload feature.</p>
<ol type="1">
<li>Checkout Wi-Fi TCP Keepalive offload Example app <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/projects/cypress/</div><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/afr-example-wlan-offloads.git</span></div><div class="line">cd afr-example-wlan-offloads</div></div><!-- fragment --></li>
<li><p class="startli">Make sure below FreeRTOSConfig.h changes are present:</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Modify the example for your Wi-Fi SSID parameters in wifi_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define WIFI_SSID                         &quot;SSID&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_PASSWORD                     &quot;PASSWORD&quot;</span></div><div class="line"><span class="preprocessor">#define WIFI_SECURITY                     eWiFiSecurityWPA2</span></div></div><!-- fragment --></li>
<li>Modify below macro in wlan_offload.h to use offload configurations from ModusToolbox Device Configurator <div class="fragment"><div class="line"><span class="preprocessor">#define USE_CONFIGURATOR_GENERATED_CONFIG    (1)</span></div></div><!-- fragment --></li>
<li>The <a class="el" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f" title="Network Monitor Function. ">wait_net_suspend()</a> used in wlan_offload.c allows the host MCU to go to deep-sleep and stay in deep-sleep until woken up by an external event. <div class="fragment"><div class="line"><a class="code" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div></div><!-- fragment --></li>
<li><p class="startli">Configure the TCP Keepalive offload. There are two ways to configure the TCP keep-alive offload one via Device configurator and other via Manual Configuration.</p>
<p class="startli">i. The easiest way to configure TCP Keepalive offload is to use the ModusToolbox Device Configurator.</p><ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT-062S2-43012/design.modus</em></li>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the psoc6pdl folder inside the amazon-freertos/vendors/cypress/psoc6/psoc6pdl/devicesupport.xml file in the window popup. This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
<li>Switch to the "Pins" tab, enable P4[1] pin, specify its name as "CYBSP_WIFI_HOST_WAKE", in the "Parameters" pane change "Interrupt Trigger Type" to "Rising Edge". If you are using a different pioneer kit, refer to its guide for Host&lt;-&gt;Device connection pinout.</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable TCP Keep Alive Offload.</li>
<li>Configure Interval, Retry Interval, Retry Count</li>
<li>Configure Source port, Destination port, Destination IP address (TCP server)</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
<p class="startli">ii. Manual configuration steps</p><ul>
<li>Read the OLM configuration from device configurator and make a copy of OLM device configurator <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_2">Code Snippet 2: Read OLM configuration from device configurator.</a></li>
<li>search for "TKO" name in the device configurator list, if present then use it establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>If TCP Keep-alive offload is not present in device configurator then add TCP keep-alive offload list <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_3">Code Snippet 3: Search for TCP KA offload in the device configurator list.</a></li>
<li>call the API to restart olm <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_4">Code Snippet 4: Use cylpa_restart_olm when the OLM configuration is changed by the user application.</a></li>
<li>Establish TCP connection <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>TCP keep-alive offload will be enabled when host MCU goes to sleep <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_1">Code Snippet 1: Using wait_net_suspend for suspend/resume network stack</a></li>
<li><b>Note</b> The maximum supported TCP connections that can be offloaded to WLAN device is 4 (MAX_TKO) this is WLAN firmware limitation, if the API <a class="el" href="group__lpautilities.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a> is invoked more than 4 times then LIFO ( Last In First Out) Algorithm is followed where the MRU(Most Recently Used) TCP connections will only be offloaded to WLAN device.</li>
</ul>
</li>
<li>Use a PC to connect to the same Wi-Fi Access Point as the PSoC 6 board. Run <a href="tcp_echo_server.py" rel="stylesheet" type="text/css"><b>tcp_echo_server.py</b></a> in that PC to act as TCP Server <div class="fragment"><div class="line">python tcp_echo_server.py --port 3360</div></div><!-- fragment --></li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">cmake -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=../../../tools/cmake/toolchains/arm-gcc.cmake</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p class="startli"><b> Make </b> </p><div class="fragment"><div class="line">cd amazon-freertos/projects/cypress/afr-example-wlan-offloads</div><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Program the board with afr-example-wlan-offloads.elf file generated under below folder using <a href="https://www.cypress.com/products/psoc-programming-solutions"><b> Cypress Programmer </b></a> <br />
 CMake : <em>amazon-freertos/projects/cypress/afr-example-wlan-offloads/build/</em> <br />
 Make : <em>amazon-freertos/build/cy/afr-example-wlan-offloads/CY8CKIT-062S2-43012/Debug</em> <br />
 When the modified afr-example-wlan-offloads starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi Access Point, and then the PSoC 6 MCU goes to System Deep Sleep. <div class="fragment"><div class="line">Info: ==================================</div><div class="line">Info: AFR Example: WLAN Offloads</div><div class="line">Info: ==================================</div><div class="line"></div><div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div><div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div><div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div><div class="line">WHD VERSION      : v1.90.2 : v1.90.2 : GCC 9.2 : 2020-04-13 02:49:57 -0500</div><div class="line">Info: --Offload Manager is initialized with the device configurator generated configuration--</div><div class="line">Info: Wi-Fi module initialized. Connecting to AP...</div><div class="line">Info: Wi-Fi connected to AP: SSID</div><div class="line">Info: IP Address acquired: 192.168.43.11</div><div class="line">TCP remote IP Address c0a82b0f  remote port:3360</div><div class="line">TCP local IP Address c0a82b0b local port:3353</div><div class="line">TCP Connection Established Successfully ctx:80124d8</div><div class="line">SetSockOpt LWIP keepalive: Interval 20, Retry Interval 3, keepalive value 20</div><div class="line">Info: Socket[0]: Created connection to IP 192.168.43.15, local port 3353, remote port 3360</div><div class="line">Info: Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[1]. Check the TCP Keepalive configuration.</div><div class="line">Info: Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[2]. Check the TCP Keepalive configuration.</div><div class="line">Info: Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[3]. Check the TCP Keepalive configuration.</div><div class="line">whd_tko_toggle: Successfully enabled</div><div class="line"></div><div class="line">Network Stack Suspended, MCU will enter DeepSleep power mode</div></div><!-- fragment --></li>
<li>Verify the TCP Keepalive offload is working as desired.Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with</li>
</ol>
<p><b>TCP Keepalive Offload enabled with 20 seconds interval configuration and WLAN DTIM configured as 3 :</b> </p><div class="image">
<img src="afr_tko_offload_low.png" alt="afr_tko_offload_low.png" height="500px"/>
</div>
<h2><a class="anchor" id="group_lpa_p2_cc"></a>
Wi-Fi Low Power Configuration Considerations</h2>
<p>The following are the different flows to configure LPA middleware:</p><ul>
<li><a class="el" href="index.html#group_lpa_p2_cc_mt_flow">ModusToolbox Device Configurator Flow</a>. Generating the initialization code using the ModusToolbox Device Configurator greatly simplifies configuring the PSoC and enabling the LPA features. The ModusToolbox Device Configurator provides the user interface to set up and automatically generate the initialization code (including analog routing) and configuration structures.</li>
<li><a class="el" href="index.html#group_lpa_p2_cc_manual_flow">Manual Configuration Flow</a>. Manually adding settings into configuration files. Manual implementation of the initialization code (including analog routing) and configuration structures is recommended for expert Users only.</li>
</ul>
<p><b>Note</b> If you modify the output of the ModusToolbox Device Configurator, you cannot import it back to the tool.</p>
<h3><a class="anchor" id="group_lpa_p2_cc_mt_flow"></a>
ModusToolbox Device Configurator Flow</h3>
<p>To open the ModusToolbox Device Configurator, right-click on the project in the Project Explorer pane in the ModusToolbox IDE, and select ModusToolbox Configurators &gt; Device Configurator.</p>
<ol type="1">
<li>Select the Wi-Fi Radio device tab (e.g., CYW4343WKUBG).</li>
<li>Enable the Wi-Fi personality and go to the Wi-Fi Parameters pane to configure the LPA Middleware.</li>
<li>Set Host Wake Configuration. Enable and assign the Host Device Interrupt Pin. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Set ARP Offload. Enable and configure the LPA with the desired parameters.</li>
<li>Set AWS MQTT Filters. Enable MQTT TLS Filter to enable corresponding filter.</li>
<li>Configure MQTT TLS Filter Configuration parameters with desired values.</li>
<li>Set Packet Filters. Enable Filter Configuration &lt;N&gt; to get access to the filter parameters.</li>
<li>Configure the enabled filter on the previous step with desired parameters.</li>
<li>Perform File-&gt;Save to generate initialization code.</li>
</ol>
<div class="image">
<img src="WIFI_Personality.png" alt="WIFI_Personality.png"/>
</div>
<p>After saving the configuration file, the generated code is available under the GeneratedSource folder, located next to the design.modus file in the BSP:</p><ul>
<li>C Data File: /GeneratedSource/cycfg_connectivity_wifi.c</li>
<li>C Header File: /GeneratedSource/cycfg_connectivity_wifi.h</li>
</ul>
<h4><a class="anchor" id="group_lpa_p1_cc_mt_flow_host_wake"></a>
Host Wake Configuration Notes</h4>
<p>By Default, WLAN host wake is configured properly and below device configurator support allows user to modify it to different GPIOs. But if user selects <b><em>Host Wake Configuration Enable</em></b> checkbox and doesnot select any pin for <b><em>Host Device Interrupt Pin</em></b>, System will Hang and this should be avoided by the user</p>
<div class="image">
<img src="hostwake_MTConfigure.png" alt="hostwake_MTConfigure.png" height="150px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_cc_manual_flow"></a>
Manual Configuration Flow</h3>
<p>Manual implementation of the initialization code (including analog routing) and configuration structures is recommended for expert Users only.</p>
<h3><a class="anchor" id="group_lpa_p2_cc_limitations"></a>
Limitations</h3>
<ol type="1">
<li>The maximum number of filters is ultimately dictated by free memory on the Wi-Fi chipset. More memory will allow more filters. Different Wi-Fi chips running FW from different branches will likely have slightly different maximum numbers of filters. It is possible to add 20 filters on a CY8CKIT_062S2_43012 kit without any issue.</li>
<li>Network stack suspend/resume functionality which is called in main.cpp function which enables Host MCU to remain in deep sleep for more duration (wake up only for external event) has a 32-Bit LP-Ticker support limitation in MbedOS (Maximum sleep-time possible is 36 hours(1.5 days). This means Host MCU will wake up without interrupt from external event after 36 hrs and then immediately goes back to sleep. This has very less power impact.</li>
</ol>
<h3><a class="anchor" id="group_lpa_p2_ipv6_filter"></a>
IPv6 Packet Filter for MCU Deep Sleep</h3>
<ul>
<li>MCU will wake for IPv6 packets intermittently, So add packet filter for IPv6 packets to avoid unnecessary wakeup. <br />
 How to configure packet Filter for IPv6 packets: <br />
<ul>
<li>Navigate to ModusToolbox installation folder and launch the ModusToolbox Device Configurator (&lt;install_dir&gt;/tools_2.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it:</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Select Enable Packet Filter Configuration 0</li>
<li>Select Filter Type as "Ether Type"</li>
<li>Select Action as "Discard"</li>
<li>Configure Ethertype as "0x86dd"</li>
<li>Save the configuration to generate the necessary code</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="group_lpa_p2_wlan_lowpower"></a>
WLAN Low Power Configuration</h3>
<p>WLAN Firmware support two different low power modes like (legacy) 802.11 PS-Poll mode and high throughput powersave mode. Refer to <a href="https://cypresssemiconductorco.github.io/wifi-host-driver/API/group__wifipowersave.html"><b> WLAN Powersave API </b></a></p>
<p>These can be configured using below Wi-Fi Host Driver APIs: <br />
</p><ol type="1">
<li><b> 802.11 PS-Poll mode </b> <div class="fragment"><div class="line"><span class="comment">// ifp : Pointer to WHD Interface</span></div><div class="line"></div><div class="line">whd_wifi_enable_powersave(ifp);</div></div><!-- fragment --></li>
<li><b> High Throughout Powersave mode </b> <div class="fragment"><div class="line"><span class="comment">// This macro specifies the duration in milliseconds for which the STA stays</span></div><div class="line"><span class="comment">// awake after receiving frames from AP in PM2 mode. The delay value must be set</span></div><div class="line"><span class="comment">// to a multiple of 10 and not equal to zero. Minimum value is 10u. Maximum</span></div><div class="line"><span class="comment">// value is 2000u.</span></div><div class="line"><span class="comment">// ifp : Pointer to WHD Interface</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define RETURN_TO_SLEEP_MS                (10u)</span></div><div class="line"></div><div class="line">whd_wifi_enable_powersave_with_throughput(ifp, RETURN_TO_SLEEP_MS);</div></div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="group_lpa_p2_cc_parameters"></a>
Configuration Parameters</h3>
<p>The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>Host Wake Configuration </td><td>Host Device Interrupt Pin </td><td>Selects the host pin which is connected to Wi-Fi device's HOST WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>Host Wake Configuration </td><td>Wi-Fi Device Interrupt Pin </td><td>Wi-Fi device GPIO_0 is reserved as device wake-up interrupt request pin (WL HOST WAKE). </td><td><ul>
<li>Read Only </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload When Host Awake </td><td>Respond to ARP Requests when Awake. </td><td><ul>
<li>Disabled (default)</li>
<li>Host Auto Reply</li>
<li>Peer Auto Reply</li>
<li>Host and Peer Auto Reply </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload When Host Sleeping </td><td>Respond to ARP Requests when Sleeping. </td><td><ul>
<li>Disabled (default)</li>
<li>Peer Auto Reply </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>Snoop Host IP from traffic when ARP Offload enabled </td><td>The host IP address is snooped from an ARP Request. If disabled, the WLAN Device will need to be informed of the Host IP address when the network interface is configured (statically or dynamically via DHCP). </td><td><ul>
<li>Off (default)</li>
<li>On </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload Cache entries expire after (s) </td><td>When the ARP cache table is offloaded from the host to the device, table entries are subject to an aging value called "peer age". </td><td><ul>
<li>1200 (default)</li>
<li>1-4294967295 </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Filter ID </td><td>Filter ID </td><td><ul>
<li>0 (for MQTT Filter)</li>
<li>1 (for MQTT TLS Filter) </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Action </td><td>Filter can either pass up packets that match the filter to the host (Keep) or drop them so the host never gets them (Discard). </td><td><ul>
<li>Keep (default)</li>
<li>Discard </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>When Active </td><td>Defines when the filter is active, when the host is awake, when it goes to sleep, or both. </td><td><ul>
<li>Sleep (default)</li>
<li>Wake</li>
<li>Always </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Protocol </td><td>Choose communication protocol. </td><td><ul>
<li>TCP (default)</li>
<li>UDP </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Direction </td><td>Inbound - destination port, outbound - source port. </td><td><ul>
<li>Destination Port (default)</li>
<li>Source Port </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Port Number </td><td>Either the single port to be filtered or the beginning of the block of contiguous numbers. When using a block, the starting port must be power of 2. </td><td><ul>
<li>8883 for TLS</li>
<li>1883 for Non TLS </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Filter ID </td><td>Filter ID </td><td><ul>
<li>0-21 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Filter Type </td><td>Each port filter can specify either a single port or a block of port numbers.<ul>
<li>Port Filter on a 16 bit UDP or TCP port number. Refer to <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter Types</a> for details of port numbers.</li>
<li>Port Block Filter of port numbers (vs a single port). Envisioned to be used by short lived ephemeral ports on source port.</li>
<li>Ether Type accepts a 16 bit ethertype value to filter on. Refer to the <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter Types</a> section (EtherTypes). Common values are 0x800 (IP) and 0x806 (ARP).</li>
<li>IP Type accepts an 8 bit IP Protocol number to filter on. Refer to the <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter Types</a> section (IPProtocols). </li>
</ul>
</td><td><ul>
<li>Port Filter</li>
<li>Port Block Filter</li>
<li>Ether Type</li>
<li>IP Type </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Action </td><td>Filter can either pass up packets that match the filter to the host (Keep) or drop them so the host never gets them (Discard). </td><td><ul>
<li>Keep (default)</li>
<li>Discard </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>When Active </td><td>Defines when the filter is active, when the host is awake, when it goes to sleep, or both. </td><td><ul>
<li>Sleep (default)</li>
<li>Wake</li>
<li>Always </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Protocol </td><td>Chooses communication protocol. Filter can be constrained to either TCP or UDP. To match either TCP or UDP use two filters, one for each. </td><td><ul>
<li>TCP (default)</li>
<li>UDP </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Direction </td><td>Inbound - destination port, outbound - source port. Packets have both a source and destination port. This specifies which one to use. A single port usually uses the destination port. </td><td><ul>
<li>Destination Port (default)</li>
<li>Source Port </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Port Number </td><td>Either the single port to be filtered or the beginning of the block of contiguous numbers. When using a block, the starting port must be a power of 2. </td><td><ul>
<li>1024 for Packet filter (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Range </td><td>Indicates the size of the block of port numbers, must be of the form (2^y - 1) and less than Port Number (Filter Type = Port Filter Block). 0 indicates just a single port. </td><td><ul>
<li>1023 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Ether Type </td><td>Enter EtherType value for desired protocol (Filter Type = Ether Type). </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>IP protocol </td><td>Enter desired IP protocol number (Filter Type = IP Type). </td><td><ul>
<li>0 (default)</li>
<li>0-255 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Interval </td><td>Enter desired Keepalive Request interval in seconds </td><td><ul>
<li>20 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Retry Interval </td><td>Keepalive retry interval in seconds if Keepalive ack is not received </td><td><ul>
<li>3 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Retry Count </td><td>Retry count in seconds if Keepalive ack is not received </td><td><ul>
<li>3 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Source port </td><td>TCP Keepalive Source port number </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Destination port </td><td>TCP Keepalive Destination port number </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Destination IP address </td><td>TCP Keepalive Destination IP address  </td><td><ul>
<li>0.0.0.0 (default) </li>
</ul>
</td></tr>
</table>
<h1><a class="anchor" id="group_lpa_p3"></a>
Part 3. Bluetooth Low Power</h1>
<p>LPA library provides features for MCU Low Power, Wi-Fi Low Power and Bluetooth Low Power. LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<p>The Bluetooth low-power feature enables the host to achieve its lowest power consumption with enabled Bluetooth. The BT Low Power personality helps configure the pin connections between the MCU host and BT device.</p>
<p>With proper configuration, it is possible to achieve low-power consumption by enabling the host MCU and BT device to enter the System Deep Sleep mode. The GPIO connection specified in the BT LPA personality should match the connections present on the target board. In most cases, the target board BSP settings have the GPIO properly set. So, change it only if the hardware is being modified. The goal of the BT LPA is to make the pin setup easier using a portable configuration layer.</p>
<p>Refer to the <a class="el" href="index.html#group_lpa_p3_cc">BT Low Power Configuration Considerations</a> section to configure the WAKE pins. The following diagram shows connections between the Host and WLAN device.</p>
<div class="image">
<img src="BTWake.png" alt="BTWake.png" height="150px"/>
</div>
<p>Where:</p><ul>
<li>UART: (CTS / TXD / RXD / RTS)</li>
<li>BT_HOST_WAKE (host wake): MCU input pin which can wake the MCU with interrupt.</li>
<li>BT_DEV_WAKE (device wake): an output MCU host pin which is connected as input BT device pin which interrupts the BT device when set in active state.</li>
</ul>
<p>Another use case for the BT LPA personality is to disable low-power mode, even though all the pins are properly connected and configured. In this case, the BT LPA personality should specify Low Power, but leave the Pins unconnected in the personality. This results in Low Power being disabled.</p>
<h2><a class="anchor" id="group_lpa_p3_qsg"></a>
Quick Start Guide</h2>
<p>This Quick Start Guide demonstrates configuring and using the BT Low Power feature in the Mbed OS/ FreeRTOS environment, as well as its impact on the system low power.</p>
<h3><a class="anchor" id="group_lpa_p3_qsg_mbedos"></a>
MBEDOS</h3>
<p>As a base for this guide, the mbed-os-example-ble example is used. This section assumes that you have an Mbed OS development environment configured. Refer to <a href="https://os.mbed.com/getting-started/">https://os.mbed.com/getting-started/</a> for instructions about how to do that.</p>
<p>Steps to create the mbed-os-example-ble/BLE_Beacon application and configure the BT low power feature.</p>
<ol type="1">
<li>Import the mbed-os-example-ble/BLE_Beacon example project and switch to the example directory: <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/ARMmbed/mbed-os-example-ble.git</span></div><div class="line">cd mbed-os-example-ble/BLE_Beacon</div><div class="line">mbed deploy</div></div><!-- fragment --></li>
<li>Configure BT Wake up Configurations. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>BT Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>BT Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li>update main.cpp in source folder with below change to update Company code <div class="fragment"><div class="line">uint16_t comp_id      = 0x0131;</div></div><!-- fragment --></li>
<li><p class="startli">Build the project and program the board. The Cypress Board's BT Powersave is configured and enabled by default. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">mbed compile -DMBED_TICKLESS --target CY8CKIT_062S2_43012 --toolchain GCC_ARM --flash</div></div><!-- fragment --><p class="startli"><b>Note</b> If you cannot program the board, make sure the board DAP-Link mode is selected. Refer to the guide of your kit of how to change the mode.</p>
</li>
<li>Open Ble scanner app in phone, Filter by mac address displayed on the serial port for this device. Click <em>bond</em> on the app<ul>
<li>CySmart BLE APP : <a href="https://play.google.com/store/apps/details?id=com.cypress.cysmart&hl=en_US">https://play.google.com/store/apps/details?id=com.cypress.cysmart&amp;hl=en_US</a></li>
</ul>
</li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. Following images show current measurement</p>
<p class="startli">i. Current measurement when BT is advertising</p>
</li>
</ol>
<pre class="fragment">\image html ble_beacon_not_connected.jpg height=500px


ii. Current measurements when when BT is connected


\image html ble_beacon_connected.jpg height=500px
</pre><ol type="1">
<li><p class="startli">To disable the BT Low Power feature or to change the BT_HOST_WAKE / BT_DEV_WAKE pins, Cypress recommends using the ModusToolbox Device Configurator. Use the appropriate connectivity device tab (for the CY8CKIT_062S2_43012 board it is CYW943012WKWBG). Click the checkbox next to Power-&gt;BT to enable/disable BT low power. Follow the instructions in sections "Host wake up signal" and "Device wake up signal" to modify the BT_HOST_WAKE and BT_DEV_WAKE pins and their polarity, respectively.</p>
<p class="startli"><b>BT Low power Disable Configurator reference</b></p><ul>
<li>Select BT Wake-Up configurations enable checkbox and don't configure Host Wake up signal &amp; Device Wake up Signal for Low power disable verification</li>
</ul>
<div class="image">
<img src="ble_Lowpower_disable_configurator.png" alt="ble_Lowpower_disable_configurator.png" height="500px"/>
</div>
<p class="startli"><b>BT Low power disable current graph</b></p>
<div class="image">
<img src="ble_Lowpower_disable.png" alt="ble_Lowpower_disable.png" height="500px"/>
</div>
</li>
<li>BLE Device details can be changed by modifying below variables in main.cpp <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t uuid[] = { 0xE2, 0x0A, 0x39, 0xF4, 0x73, 0xF5, 0x4B, 0xC4,</div><div class="line">                                        0xA1, 0x2F, 0x17, 0xD1, 0xAD, 0x07, 0xA9, 0x61 };</div><div class="line">uint16_t major_number = 1122;</div><div class="line">uint16_t minor_number = 3344;</div><div class="line">uint16_t tx_power     = 0xC8;</div><div class="line">uint16_t comp_id      = 0x004C;</div></div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="group_lpa_p3_qsg_anycloud"></a>
FREERTOS</h3>
<p>mtb-example-anycloud-ble-wifi-onboarding is used as base for this guide.</p>
<p>Steps to create the mtb-example-anycloud-ble-wifi-onboarding application and configure the BT low power feature.</p>
<ol type="1">
<li>Clone the example repo and switch to the example directory: <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/mtb-example-anycloud-ble-wifi-onboarding.git</span></div><div class="line">cd mtb-example-anycloud-ble-wifi-onboarding</div></div><!-- fragment --></li>
<li>Make sure CY8CKIT-062S2-43012.lib file is present inside deps folder <div class="fragment"><div class="line">TARGET_CY8CKIT-062S2-43012.lib : https:<span class="comment">//github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012/#latest-v2.X</span></div><div class="line"></div><div class="line"><span class="preprocessor"># MTB2.2 and .mtb approach , make sure below mtb files are present</span></div><div class="line"><span class="preprocessor">echo https://github.com/cypresssemiconductorco/TARGET_CY8CKIT-062S2-43012#latest-v2.X#\$\$ASSET_REPO\$\$/TARGET_CY8CKIT-062S2-43012/latest-v2.X &gt; deps/TARGET_CY8CKIT-062S2-43012.mtb</span></div></div><!-- fragment --></li>
<li><p class="startli">Check FreeRTOSConfig.h if below changes to enable MCU Deep Sleep Functionality is present</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li>Configure BT Wake up Configurations. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>BT Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>BT Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li>Build the project and program the board. The Cypress Board's BT Powersave is configured and enabled by default. The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make getlibs</div><div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div></div><!-- fragment --></li>
<li>Open Ble scanner app in phone, Filter by mac address displayed on the serial port for this device. Click <em>bond</em> on the app<ul>
<li>CySmart BLE APP : <a href="https://play.google.com/store/apps/details?id=com.cypress.cysmart&hl=en_US">https://play.google.com/store/apps/details?id=com.cypress.cysmart&amp;hl=en_US</a></li>
</ul>
</li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. Following image show current measurement with BLE advertising and connected. <br />
 High Current Spike in PSoC6 is due to WiFi</p>
<div class="image">
<img src="ble_beacon_anycloud.png" alt="ble_beacon_anycloud.png" height="500px"/>
</div>
</li>
<li>To disable the BT Low Power feature or to change the BT_HOST_WAKE / BT_DEV_WAKE pins, Cypress recommends using the ModusToolbox Device Configurator. Use the appropriate connectivity device tab (for the CY8CKIT_062S2_43012 board it is CYW943012WKWBG). Click the checkbox next to Power-&gt;BT to enable/disable BT low power. Follow the instructions in sections "Host wake up signal" and "Device wake up signal" to modify the BT_HOST_WAKE and BT_DEV_WAKE pins and their polarity, respectively.</li>
</ol>
<h3><a class="anchor" id="group_lpa_p3_qsg_afr"></a>
AFR</h3>
<p>ble demo application in Amazon FreeRTOS SDK is used as base for this guide.</p>
<p>Steps to compile ble demo application and configure the BT low power feature. <br />
 NOTE: This is just to show BT LPA configurations and does not verify BLE services</p>
<ol type="1">
<li>Clone the example repo and switch to the example directory: <div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/cypresssemiconductorco/amazon-freertos.git --recurse-submodules</span></div><div class="line">cd amazon-freertos/demos/ble</div></div><!-- fragment --></li>
<li>Comment out below lines in vendors/cypress/boards/CY8CKIT_062S2_43012/aws_demos/application_code/main.c <div class="fragment"><div class="line"><span class="comment">//tcpip_init(NULL, NULL);    # This is make sure LWIP timers are not running(else there will be 100ms PSoC6 wakeup)</span></div><div class="line"><span class="comment">//prvWifiConnect();          # Disable WiFi Connect for this example </span></div><div class="line"><span class="comment">//vDevModeKeyProvisioning(); # Disable Device provision</span></div></div><!-- fragment --></li>
<li>Update below macros in vendors/cypress/boards/CY8CKIT_062S2_43012/aws_demos/config_files/aws_demo_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define CONFIG_BLE_GATT_SERVER_DEMO_ENABLED                      # Updated from CONFIG_MQTT_DEMO_ENABLED</span></div><div class="line"><span class="preprocessor">#define democonfigNETWORK_TYPES     ( AWSIOT_NETWORK_TYPE_BLE )</span></div></div><!-- fragment --></li>
<li>Update below macro in vendors/cypress/boards/CY8CKIT_062S2_43012/aws_demos/config_files/aws_iot_network_config.h <div class="fragment"><div class="line"><span class="preprocessor">#define configENABLED_NETWORKS      ( AWSIOT_NETWORK_TYPE_BLE )</span></div></div><!-- fragment --></li>
<li>Comment out below task in demos/ble/aws_ble_gatt_server_demo.c (This is just to avoid PsoC6 waking up every one second) <div class="fragment"><div class="line">In vGattDemoSvcHook Function,</div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line">    <span class="keywordflow">if</span>( xRet == pdTRUE )</div><div class="line">    {</div><div class="line">        xRet = xTaskCreate(</div><div class="line">            vCounterUpdateTaskFunction,</div><div class="line">            <span class="stringliteral">&quot;GattDemoCounterTask&quot;</span>,</div><div class="line">            configMINIMAL_STACK_SIZE * 4,</div><div class="line">            NULL,</div><div class="line">            tskIDLE_PRIORITY,</div><div class="line">            &amp;xCounterUpdateTask );</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
<li><p class="startli">Update vendors/cypress/boards/CY8CKIT_062S2_43012/aws_demos/config_files/FreeRTOSConfig.h with below changes to enable MCU Deep Sleep Functionality</p>
<p class="startli">configUSE_TICKLESS_IDLE : This change to support Tickless Deep Sleep mode </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cycfg_system.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_SLEEP) || (CY_CFG_PWR_SYS_IDLE_MODE == CY_CFG_PWR_MODE_DEEPSLEEP)</span></div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> vApplicationSleep( uint32_t xExpectedIdleTime );</div><div class="line"><span class="preprocessor">#define portSUPPRESS_TICKS_AND_SLEEP( xIdleTime ) vApplicationSleep( xIdleTime )</span></div><div class="line"><span class="preprocessor">#define configUSE_TICKLESS_IDLE  2</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if CY_CFG_PWR_DEEPSLEEP_LATENCY &gt; 0</span></div><div class="line"><span class="preprocessor">#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   CY_CFG_PWR_DEEPSLEEP_LATENCY</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">// Add below line </span></div><div class="line"><span class="preprocessor">#define IOT_BLE_ADD_CUSTOM_SERVICES ( 1 )</span></div></div><!-- fragment --></li>
<li>Configure BT Wake up Configurations. This step can be done by using the ModusToolbox Device Configurator or by manually updating the code.<ul>
<li><b>BT Low power using the ModusToolbox Device Configurator</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_mt_flow">ModusToolbox Device Configurator Flow</a></li>
<li><b>BT Low power Manual configuration</b> Refer to <a class="el" href="index.html#group_lpa_p3_cc_manual_flow">Manual Configuration Flow</a></li>
</ul>
</li>
<li><p class="startli">Build the project using CMake / Make. <br />
 The following command is example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain:</p>
<p class="startli"><b> CMake </b> </p><div class="fragment"><div class="line">cd amazon-freertos/demos/ble</div><div class="line">cmake -G Ninja -DVENDOR=cypress -DBOARD=CY8CKIT_062S2_43012 -DCOMPILER=arm-gcc -S ../../ -B build -DBLE_SUPPORTED=1 -DAFR_TOOLCHAIN_PATH=../../tools/</div><div class="line">cmake --build build --clean-first</div></div><!-- fragment --><p class="startli"><b> Make </b> </p><div class="fragment"><div class="line">cd projects/cypress/CY8CKIT_062S2_43012/mtb/aws_demos/</div><div class="line">*** Make sure BLE_SUPPORT=1 in Makefile ***</div><div class="line">make build</div></div><!-- fragment --></li>
<li>Open Ble scanner app in phone, Filter by mac address displayed on the serial port for this device. Click <em>bond</em> on the app<ul>
<li>CySmart BLE APP : <a href="https://play.google.com/store/apps/details?id=com.cypress.cysmart&hl=en_US">https://play.google.com/store/apps/details?id=com.cypress.cysmart&amp;hl=en_US</a></li>
</ul>
</li>
<li><p class="startli">Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to Measure Power Consumption</a> section for corresponding instructions. Following image show current measurement with BLE advertising and connected. <br />
 High Current may be due to Demo app using WiFi and GATT Timer running every one second</p>
<div class="image">
<img src="ble_beacon_afr.png" alt="ble_beacon_afr.png" height="500px"/>
</div>
</li>
<li>To disable the BT Low Power feature or to change the BT_HOST_WAKE / BT_DEV_WAKE pins, Cypress recommends using the ModusToolbox Device Configurator. Use the appropriate connectivity device tab (for the CY8CKIT_062S2_43012 board it is CYW943012WKWBG). Click the checkbox next to Power-&gt;BT to enable/disable BT low power. Follow the instructions in sections "Host wake up signal" and "Device wake up signal" to modify the BT_HOST_WAKE and BT_DEV_WAKE pins and their polarity, respectively.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p3_cc"></a>
BT Low Power Configuration Considerations</h2>
<p>The following are the different flows to configure LPA middleware:</p><ul>
<li><a class="el" href="index.html#group_lpa_p3_cc_mt_flow">ModusToolbox Device Configurator Flow</a>. Generating the initialization code using the ModusToolbox Device Configurator greatly simplifies configuring the PSoC and enabling the LPA features. The ModusToolbox Device Configurator provides the user interface to set up and automatically generate the initialization code (including analog routing) and configuration structures.</li>
<li><a class="el" href="index.html#group_lpa_p3_cc_manual_flow">Manual Configuration Flow</a>. Manually adding settings into configuration files. Manual implementation of the initialization code (including analog routing) and configuration structures is recommended for expert Users only.</li>
</ul>
<p><b>Note</b> If you modify the output of the ModusToolbox Device Configurator, you cannot import it back to the tool.</p>
<h3><a class="anchor" id="group_lpa_p3_cc_mt_flow"></a>
ModusToolbox Device Configurator Flow</h3>
<p>Mandatory steps to avoid design.modus file modification inside checkout repo</p>
<p><b>mbedos</b> </p>
<ul>
<li>Copy folder mbed-os-example-ble/BLE_Beacon/mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/TARGET_CY8CKIT_062S2_43012 to mbed-os-example-ble/BLE_Beacon folder</li>
<li>Delete all files in mbed-os-example-ble/BLE_Beacon/TARGET_CY8CKIT_062S2_43012 except COMPONENT_BSP_DESIGN_MODUS folder and its contents</li>
<li>Rename mbed-os-example-ble/BLE_Beacon/TARGET_CY8CKIT_062S2_43012/COMPONENT_BSP_DESIGN_MODUS to mbed-os-example-ble/BLE_Beacon/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Delete design.cyqspi and design.cycapsense file in mbed-os-example-ble/BLE_Beacon/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>Add/update mbed_app.json in mbed-os-example-ble/BLE_Beacon folder with below details (This will tell mbed to ignore the BSP configuration shipped with MbedOS). Make sure to add board specific target.components.remove field under target_overrides <div class="fragment"><div class="line">{</div><div class="line">     <span class="stringliteral">&quot;target_overrides&quot;</span>: {</div><div class="line">          <span class="stringliteral">&quot;CY8CKIT_062S2_43012&quot;</span>: {</div><div class="line">              <span class="stringliteral">&quot;target.components_remove&quot;</span>: [<span class="stringliteral">&quot;BSP_DESIGN_MODUS&quot;</span>]</div><div class="line">         }</div><div class="line">     }</div><div class="line"> }</div></div><!-- fragment --></li>
<li>If mbed-os branch used is 5.15 or above, please do the below changes as well<ul>
<li>update mbed_app.json with below line in "target_overrides": <div class="fragment"><div class="line"><span class="stringliteral">&quot;target.components_add&quot;</span>: [<span class="stringliteral">&quot;CUSTOM_DESIGN_MODUS&quot;</span>]</div></div><!-- fragment --></li>
</ul>
</li>
</ul>
<p><b>FreeRTOS</b> <br />
 Ignore this step if application already added this COMPONENT_CUSTOM_DESIGN_MODUS Folder <br />
</p><ol type="1">
<li>Copy contents of folder mtb-example-anycloud-ble-wifi-onboarding/libs/TARGET_CY8CKIT-062S2-43012/COMPONENT_BSP_DESIGN_MODUS to mtb-example-anycloud-ble-wifi-onboarding/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT_062S2_43012 folder</li>
<li>Delete design.cyqspi and design.cycapsense file in mtb-example-anycloud-ble-wifi-onboarding/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS</li>
<li>update Makefile in mtb-example-anycloud-ble-wifi-onboarding folder with below details (This will tell build to ignore the BSP configuration inside libs folder) <div class="fragment"><div class="line">COMPONENTS+=CUSTOM_DESIGN_MODUS</div><div class="line">DISABLE_COMPONENTS=BSP_DESIGN_MODUS </div></div><!-- fragment --></li>
</ol>
<p>To open the ModusToolbox Device Configurator, right-click on the project in the Project Explorer pane in the ModusToolbox IDE, and select ModusToolbox Configurators &gt; Device Configurator.</p>
<ol type="1">
<li><b>MBEDOS</b> : Open <em>mbed-os-example-ble/BLE_Beacon/TARGET_CY8CKIT_062S2_43012/CUSTOM_BSP_DESIGN_MODUS/design.modus</em> <br />
 <b>FREERTOS</b> : Open <em>mtb-example-anycloud-ble-wifi-onboarding/COMPONENT_CUSTOM_DESIGN_MODUS/TARGET_CY8CKIT_062S2_43012/design.modus</em> <br />
 <b>AFR</b> : Open <em>vendors/cypress/boards/CY8CKIT_062S2_43012/aws_demos/application_code/cy_code/design.modus</em><ul>
<li>If the design.modus file does not open and pops with a error message <em>No device support library path provided </em>, then point to the devicesupport.xml file in psoc6pdl folder <br />
 <b>MBEDOS:</b> mbed-os/targets/TARGET_Cypress/TARGET_PSOC6/psoc6pdl/devicesupport.xml <br />
 <b>FREERTOS:</b> mtb-example-anycloud-ble-wifi-onboarding/libs/psoc6pdl/devicesupport.xml <br />
 <b>AFR:</b> vendors/cypress/MTB/psoc6/psoc6pdl/devicesupport.xml <br />
 This is because the design.modus file will update its path to the PDL directory when it is opened for the first time.</li>
</ul>
</li>
<li>Select Wi-Fi Radio device tab (for example, CYW4343WKUBG).</li>
<li>Enable the BT resource and go to the BT Parameters pane to configure the LPA Middleware.</li>
<li>Enable BT Wake Configuration.</li>
<li>Choose a pin for Host-wake-up signal. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Choose a pin for Device-wake-up signal and Device-wake-up trigger interrupt type. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Perform File-&gt;Save to generate initialization code.</li>
</ol>
<div class="image">
<img src="BT_Personality.png" alt="BT_Personality.png" height="250px"/>
</div>
<p>After saving the configuration file, the generated code is available under the GeneratedSource folder, located next to the design.modus file in the BSP:</p><ul>
<li>C Data File: /GeneratedSource/cycfg_connectivity_bt.c</li>
<li>C Header File: /GeneratedSource/cycfg_connectivity_bt.h</li>
</ul>
<h3><a class="anchor" id="group_lpa_p3_cc_manual_flow"></a>
Manual Configuration Flow</h3>
<p>To configure MCU LPA Middleware related parameters not using ModusToolbox Device Configurator, do the following steps:</p>
<ol type="1">
<li>Find and open the cycfg_connectivity_bt.h file under .../COMPONENT_BSP_DESIGN_MODUS/GeneratedSource/folder with a text editor.</li>
<li>To configure Host-Wake-Up Signal parameter add/modify the following macros: <div class="fragment"><div class="line"><span class="preprocessor">#define CYCFG_BT_HOST_WAKE_GPIO CYBSP_CSD_TX_HAL_PORT_PIN</span></div><div class="line"><span class="preprocessor">#define CYCFG_BT_HOST_WAKE_IRQ_EVENT CYCFG_BT_WAKE_EVENT_ACTIVE_LOW</span></div></div><!-- fragment --></li>
<li>To configure Device-Wake-Up Signal parameter add/modify the following macros: <div class="fragment"><div class="line"><span class="preprocessor">#define CYCFG_BT_DEV_WAKE_GPIO CYBSP_WIFI_SDIO_DAT0_HAL_PORT_PIN</span></div><div class="line"><span class="preprocessor">#define CYCFG_BT_DEV_WAKE_POLARITY CYCFG_BT_WAKE_EVENT_ACTIVE_LOW</span></div></div><!-- fragment --></li>
<li>Save changes.</li>
</ol>
<p><b>Note</b> Using the ModusToolbox Device Configurator overwrites changes you made in the cycfg_connectivity_bt.h file.</p>
<p><b>Note</b> The board Pin connections must match the manual settings. If the BSP pins are being changed, then it will require some board rework to match the hardware connections to the manually changed connections.</p>
<h3><a class="anchor" id="group_lpa_p3_cc_parameters"></a>
Configuration Parameters</h3>
<p>The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>Host Wake Configuration </td><td>Host-Wake-Up Signal </td><td>Select the host pin which is connected to BT device's BT_HOST_WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>Host Wake Configuration </td><td>Host-Wake-IRQ-Event </td><td>Select the Trigger for Host wake IRQ event. </td><td><ul>
<li>Falling Edge (Active Low) (default)</li>
<li>Rising Edge (Active High) </li>
</ul>
</td></tr>
<tr>
<td>BT Device Wake Configuration </td><td>Device-Wake-Up Signal </td><td>Select the host pin which is connected to BT device's BT_DEV_WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>BT Device Wake Configuration </td><td>Device-Wake-Up Polarity </td><td>Select the Polarity condition for BT_DEV_WAKE signal. </td><td><ul>
<li>Active Low (default)</li>
<li>Active High </li>
</ul>
</td></tr>
</table>
<h1><a class="anchor" id="section_lpa_measurement"></a>
How to Measure Power Consumption</h1>
<p>This section describes how to measure power consumption for the CY8CKIT-062S2-43012 kit used in the Quick Start Guide sections. Refer to the guide of your kit of how to measure power consumption.</p>
<p>To prepare your equipment and measure the current consumption do the following steps:</p>
<ul>
<li>DC Power analyzer used:<ul>
<li>Disconnect the KitProg USB cable to power off the board.</li>
<li><p class="startli">Optional: To prevent the current leakages and observe the real current consumption remove the following components:</p><ul>
<li>For base board versions &gt; Rev02 : Remove the jumper J25.</li>
<li>For base board versions &lt;= Rev02 : Remove the potentiometer R1.</li>
</ul>
<p class="startli"><b>Note</b> If you do not remove the component you still be able to observe approximate current consumption but due to the current leakage it is slightly higher.</p>
</li>
<li>Connect the negative probe to the GND test point.</li>
<li>Remove the J15 jumper and connect the positive probe to the J15 P6.VDD pin for PSoC6 Measurement.</li>
<li>Configure the DC Power Analyzer to 3.3 V DC output.</li>
<li>Remove the J8 jumper and connect the positive probe to the J8 VBAT 1 pin for WLAN 43012 Measurement.</li>
<li>Configure the DC Power Analyzer to 3.6 V DC output.</li>
<li>Power on the board by connecting the KitProg USB cable again.</li>
<li>Enable DC output on the DC Power Analyzer.</li>
</ul>
</li>
<li>Ammeter used:<ul>
<li>Disconnect the KitProg USB cable to power off the board.</li>
<li><p class="startli">Optional: To prevent the current leakages and observe the real current consumption remove the following components:</p><ul>
<li>For base board versions &gt; Rev02 : Remove the jumper J25.</li>
<li>For base board versions &lt;= Rev02 : Remove the potentiometer R1.</li>
</ul>
<p class="startli"><b>Note</b> If you do not remove the component you still be able to observe approximate current consumption but due to the current leakage it is slightly higher.</p>
</li>
<li>Remove the J15 jumper and connect the negative probe to the J15 P6.VDD pin for PSoC6 Measurement.</li>
<li>Connect the positive probe to the J15 VTARG pin.</li>
<li>Remove the J8 jumper and connect the negative probe to the J8 VCC VBAT 1 pin for WLAN 43012 Measurement.</li>
<li>Connect the positive probe to the J8 VCC VBAT pin (Pin 2).</li>
<li>Power on the board by connecting the KitProg USB cable again.</li>
<li>Turn on the Ammeter.</li>
</ul>
</li>
</ul>
<p>This section describes how to measure power consumption for the CY8CEVAL-062S2 kit + (4339 or 4373). Refer to the guide of your kit of how to measure power consumption.</p>
<p>To prepare your equipment and measure the current consumption do the following steps:</p>
<ul>
<li>DC Power analyzer used:<ul>
<li>Disconnect the KitProg USB cable to power off the board.</li>
<li><p class="startli">Optional: To prevent the current leakages and observe the real current consumption remove the following components:</p><ul>
<li>For base board versions &gt; Rev04 : Remove the jumper J21 (VDDA - VDD_POT)</li>
</ul>
<p class="startli"><b>Note</b> If you do not remove the component you still be able to observe approximate current consumption but due to the current leakage it is slightly higher.</p>
</li>
<li>Connect the negative probe to the GND test point(TP6).</li>
<li>Remove the J18 jumper (i.e MCU power selection jumper)</li>
<li>Remove the J15 jumper and connect the positive probe to the J15 P6.VDD pin for PSoC6 Measurement.</li>
<li>Configure the DC Power Analyzer to 3.3 V DC output.</li>
<li>Remove the J11 jumper and connect the positive probe to the J11 VBAT 1 pin for WLAN 43012 Measurement.</li>
<li>Configure the DC Power Analyzer to 3.6 V DC output.</li>
<li>Power on the board by connecting the KitProg USB cable again.</li>
<li>Enable DC output on the DC Power Analyzer.</li>
</ul>
</li>
<li>Ammeter used:<ul>
<li>Disconnect the KitProg USB cable to power off the board.</li>
<li><p class="startli">Optional: To prevent the current leakages and observe the real current consumption remove the following components:</p><ul>
<li>For base board versions &gt; Rev04 : Remove the jumper J21 (VDDA - VDD_POT)</li>
</ul>
<p class="startli"><b>Note</b> If you do not remove the component you still be able to observe approximate current consumption but due to the current leakage it is slightly higher.</p>
</li>
<li>Remove the J15 jumper and connect the negative probe to the J15 P6.VDD pin for PSoC6 Measurement.</li>
<li>Connect the positive probe to the J15 VTARG pin.</li>
<li>Remove the J11 jumper and connect the negative probe to the J11 VCC VBAT 1 pin for WLAN 43012 Measurement.</li>
<li>Connect the positive probe to the J11 VCC VBAT pin (Pin 2).</li>
<li>Power on the board by connecting the KitProg USB cable again.</li>
<li>Turn on the Ammeter.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="section_lpa_performance"></a>
Performance Data</h1>
<p><b>Note</b> The Performance Data report is measured on CY8CKIT_062S2_43012 board. <br />
 Lower MCU Current for AFR and FreeRTOS cases is due to the fact that app disables the Phase-Locked Loop (PLL), disables the HF clock for unused peripherals like audio/USB, and configures the Buck regulator instead of the Low Dropout (LDO) regulator to power the PSoC 6 MCU device. <br />
</p>
<table class="doxtable">
<tr>
<th>Quick Start Guide Example </th><th>SDK  </th><th>Based On  </th><th>PSoC6 + CYW943012 Average current<br />
Without LPA </th><th>PSoC6 + CYW943012 Average current<br />
With LPA </th><th>Configurations </th><th>Notes  </th></tr>
<tr>
<td rowspan="3">MCU Low Power QSG </td><td>MBEDOS </td><td>mbed-os-blinky-led </td><td align="center">17.9mA </td><td align="center">25.9uA </td><td rowspan="3">Without LPA: MCU Idle power mode set to Active<br />
With LPA: MCU Idle power mode set to Deep Sleep </td><td rowspan="3"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-psoc6-empty-app </td><td align="center">17.2mA </td><td align="center">24uA </td></tr>
<tr>
<td>AFR </td><td>afr-example-wlan-lowpower </td><td align="center">1.6mA </td><td align="center">29uA  </td></tr>
<tr>
<td rowspan="3">Wi-Fi ARP offload QSG </td><td>MBEDOS </td><td>mbed-os-example-wifi </td><td align="center">4.7mA </td><td align="center">360uA </td><td rowspan="3">Without LPA: ARP offload not enabled<br />
With LPA: ARP offloads enabled<br />
MCU Idle power mode set to Deep Sleep for both use cases.<br />
ARP pings every 3 seconds for total 30 seconds duration <ul>
<li>
beacon interval : 100ms </li>
<li>
DTIM : 3 </li>
</ul>
</td><td rowspan="3"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-anycloud-wlan-lowpower </td><td align="center">2.85mA </td><td align="center">600uA  </td></tr>
<tr>
<td>AFR </td><td>afr-example-wlan-offloads </td><td align="center">770uA </td><td align="center">290uA  </td></tr>
<tr>
<td rowspan="3">Wi-Fi Packet filter QSG </td><td>MBEDOS </td><td>mbed-os-example-wifi </td><td align="center">6.2mA </td><td align="center">400uA </td><td rowspan="3">Without LPA: No Packet filters configured<br />
With LPA: ICMP ping packets filtered<br />
MCU Idle power mode set to Deep Sleep for both use cases. <br />
Ping packets every 3 seconds for duration of 30 secs <ul>
<li>
beacon interval : 100ms </li>
<li>
DTIM : 3 </li>
</ul>
</td><td rowspan="3"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-anycloud-wlan-lowpower </td><td align="center">2.5mA </td><td align="center">350uA  </td></tr>
<tr>
<td>AFR </td><td>afr-example-wlan-offloads </td><td align="center">1.4mA </td><td align="center">235uA  </td></tr>
<tr>
<td rowspan="3">Wi-Fi TCP Keepalive Offload QSG </td><td>MBEDOS </td><td>mbed-os-example-wifi </td><td align="center">19.5mA </td><td align="center">550uA </td><td rowspan="3">Without LPA: TCP Keepalive offload not enabled<br />
With LPA: TCP Keepalive offload enabled<br />
MCU Idle power mode set to Deep Sleep for both use cases. <ul>
<li>
TCP Keepalive interval : 20 seconds </li>
<li>
beacon interval : 100ms </li>
<li>
DTIM : 3 </li>
<li>
PM2_SLEEP_RET : 10ms </li>
</ul>
</td><td rowspan="3"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-anycloud-offload-tcp-keepalive </td><td align="center">1.6mA </td><td align="center">600uA  </td></tr>
<tr>
<td>AFR </td><td>afr-example-wlan-offloads </td><td align="center">1.6mA </td><td align="center">236uA  </td></tr>
<tr>
<td rowspan="3">BT Low Power QSG <br />
(BT Advertising) </td><td>MBEDOS </td><td>mbed-os-example-ble/BLE_Beacon </td><td align="center">12.5mA </td><td align="center">80.5uA </td><td rowspan="3">Without LPA: BT low power not enabled<br />
With LPA: BT low power enabled<br />
MCU Idle power mode set to Deep Sleep for both use cases <br />
BLE Advertising interval : 1000ms </td><td rowspan="3"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-anycloud-ble-wifi-onboarding </td><td align="center">3.4mA </td><td align="center">350uA  </td></tr>
<tr>
<td>AFR </td><td>demos/ble </td><td align="center">4.5mA </td><td align="center">80uA  </td></tr>
<tr>
<td rowspan="3">BT Low Power QSG <br />
(BT Connected) </td><td>MBEDOS </td><td>mbed-os-example-ble/BLE_Beacon </td><td align="center">18.5mA </td><td align="center">550uA </td><td rowspan="3">Without LPA: BT low power not enabled<br />
With LPA: BT low power enabled<br />
MCU Idle power mode set to Deep Sleep for both use cases <br />
BLE Advertising interval : 1000ms  </td><td rowspan="2"></td></tr>
<tr>
<td>Low Power Assistant(FreeRTOS) </td><td>mtb-example-anycloud-ble-wifi-onboarding </td><td align="center">3.5mA </td><td align="center">760uA  </td></tr>
<tr>
<td>AFR </td><td>demos/ble </td><td align="center">4.5mA </td><td align="center">3.5mA </td><td>High Current is due to <br />
 <ul>
<li>
BLE Demo app using Wi-Fi </li>
<li>
Wakes up every one second due to GATT Timer </li>
</ul>
</td></tr>
</table>
<h1><a class="anchor" id="section_lpa_hostwake"></a>
Wi-Fi Host Wake Configuration</h1>
<h2><a class="anchor" id="section_lpa_hostwake_CY8CKIT_062_WIFI_BT"></a>
CY8CKIT_062_WIFI_BT</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P2[7] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Rising Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_4343_062_kit.png" alt="hostwake_config_4343_062_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_hostwake_CY8CKIT_062S2_43012"></a>
CY8CKIT_062S2_43012</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P4[1] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Rising Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_43012_062S2_kit.png" alt="hostwake_config_43012_062S2_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_hostwake_CY8CPROTO_062_4343W"></a>
CY8CPROTO_062_4343W</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P0[4] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Rising Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_4343W_062_kit.png" alt="hostwake_config_4343W_062_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_hostwake_CY8CEVAL_062S2_4373"></a>
CY8CEVAL_062S2_LAI_4373M2</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P4[1] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Rising Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_4373_062S2_eval_kit.png" alt="hostwake_config_4373_062S2_eval_kit.png" height="430px"/>
</div>
<h2><a class="anchor" id="section_lpa_hostwake_CY8CEVAL_062S2_43439"></a>
CY8CEVAL_062S2_MUR_43439M2</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P4[1] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Resistive Pull up. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Falling Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_43439_062S2_eval_kit.png" alt="hostwake_config_43439_062S2_eval_kit.png" height="430px"/>
</div>
<h1><a class="anchor" id="section_lpa_bt_wakeconfig"></a>
BT Wake Configuration</h1>
<h2><a class="anchor" id="section_lpa_bt_wakeconfig_CY8CKIT_062_WIFI_BT"></a>
CY8CKIT_062_WIFI_BT</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the BT Host wake pin P3[5] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the BT Device wake pin P4[0] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to BT tab in CYW4343WKUBG and change the following.<ul>
<li>Enable BT Wake up Configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_4343_062_kit.png" alt="btwake_config_4343_062_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_bt_wakeconfig_CY8CKIT_062S2_43012"></a>
CY8CKIT_062S2_43012</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the BT Device wake pin P3[5] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the BT Host wake pin P4[0] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to BT tab in CYW43012C0WKWBG and change the following.<ul>
<li>Enable BT Wake up Configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_43012_062S2_kit.png" alt="btwake_config_43012_062S2_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_bt_wakeconfig_CY8CEVAL_062S2_4373"></a>
CY8CEVAL_062S2_LAI_4373M2</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the BT Device wake pin P2[7] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the BT Host wake pin P4[0] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to BT tab in CYW4373EUBGT and change the following.<ul>
<li>Enable BT Wake up Configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_4373_062S2_eval_kit.png" alt="btwake_config_4373_062S2_eval_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_bt_wakeconfig_CY8CEVAL_062S2_4339"></a>
CY8CEVAL_062S2_MUR_43439M2</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the BT Device wake pin P3[5] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the BT Host wake pin P4[0] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to BT tab in CYW43439KUBG and change the following.<ul>
<li>Enable BT Wake up Configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_4339_062S2_eval_kit.png" alt="btwake_config_4339_062S2_eval_kit.png" height="400px"/>
</div>
<h2><a class="anchor" id="section_lpa_bt_wakeconfig_CY8CPROTO_062_4343W"></a>
CY8CPROTO_062_4343W</h2>
<ul>
<li>On the PSoC6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the BT Device wake pin P3[5] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the BT Host wake pin P4[0] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to BT tab in CYW4343WKUBG and change the following.<ul>
<li>Enable BT Wake up Configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_4343W_062_kit.png" alt="btwake_config_4343W_062_kit.png" height="400px"/>
</div>
<h1><a class="anchor" id="section_lpa_toolchain"></a>
Supported Software and Tools</h1>
<p>This version of the LPA Middleware was validated for compatibility with the following Software and Tools:</p>
<table class="doxtable">
<tr>
<th>Software and Tools </th><th>Version  </th></tr>
<tr>
<td>ModusToolbox Software Environment </td><td>2.2  </td></tr>
<tr>
<td>- ModusToolbox Device Configurator </td><td>2.2  </td></tr>
<tr>
<td>- Power Personality in Device Configurator </td><td>1.2  </td></tr>
<tr>
<td>- Wi-Fi Personality in Device Configurator </td><td>1.0  </td></tr>
<tr>
<td>- BT Personality in Device Configurator </td><td>1.0  </td></tr>
<tr>
<td>GCC compiler for MBED-OS </td><td>9.2.0  </td></tr>
<tr>
<td>GCC compiler for ModusToolbox </td><td>9.3.0  </td></tr>
<tr>
<td>GCC compiler for Amazon FreeRTOS </td><td>7.2.1  </td></tr>
<tr>
<td>IAR Compiler </td><td>8.32  </td></tr>
<tr>
<td>ARM Compiler 6 </td><td>6.14  </td></tr>
<tr>
<td>MBED OS </td><td>6.8.0  </td></tr>
<tr>
<td>Amazon FreeRTOS </td><td>V202007.00  </td></tr>
</table>
<h1><a class="anchor" id="group_lpa_misra"></a>
MISRA-C Compliance</h1>
<p>If you need a MISRA compliance report for this library, please create a ticket at <a href="www.cypress.com/support"><b>www.cypress.com/support</b></a></p>
<h1><a class="anchor" id="group_lpa_errata"></a>
Errata</h1>
<p>This section lists the known problems with the LPA middleware.</p>
<h1><a class="anchor" id="group_lpa_changelog"></a>
Changelog</h1>
<table class="doxtable">
<tr>
<th>Version</th><th>Changes</th><th>Comments </th></tr>
<tr>
<td>4.0.0 </td><td>Add LPA support for 43439 Kit  </td><td>LPA v4.0.0   </td></tr>
<tr>
<td>3.2.0 </td><td>Add LPA support for 4373 Kit  </td><td>LPA v3.2.0   </td></tr>
<tr>
<td>3.1.1 </td><td>Fix for wait_net_suspend with TCPIP core locking Configuration  </td><td>LPA v3.1.1   </td></tr>
<tr>
<td>3.1.0 </td><td>Minor Fixes and documentation update  </td><td>MBED OS 6.8.0 , LPA v3.1.0 , Amazon FreeRTOS v202007.00   </td></tr>
<tr>
<td>3.0.0 </td><td>LPA Middleware for all SDK(s)  </td><td>MBED OS 6.2.0 , LPA v3.0.0 , Amazon FreeRTOS v202007.00   </td></tr>
<tr>
<td rowspan="2">2.1.0(ER) </td><td>Add LPA Support to Amazon FreeRTOS release  </td><td>Added AFR SDK support to Wi-Fi Only LPA   </td></tr>
<tr>
<td>Support WLAN Low power configurations in LPA for all OS  </td><td>Feature enhancement  </td></tr>
<tr>
<td rowspan="2">2.0.0 </td><td>Add LPA Support to FreeRTOS  </td><td>LPA v2.0.0   </td></tr>
<tr>
<td>Add TCP Keepalive offload support  </td><td>Feature enhancement  </td></tr>
<tr>
<td>1.0.0 </td><td>The initial version </td><td></td></tr>
</table>
<h1><a class="anchor" id="section_lpa_more_information"></a>
More Information</h1>
<p>For more information, Cypress highly recommends starting with these documents.</p>
<ul>
<li><a href="https://github.com/Infineon/lpa"><b>Cypress GitHub LPA Middleware</b></a></li>
<li><a href="https://www.cypress.com/products/modustoolbox-software-environment"><b>ModusToolbox Software Environment, Quick Start Guide, Documentation, and Videos</b></a></li>
<li><a href="https://github.com/Infineon/mbed-os-example-wlan-lowpower"><b>LPA Middleware Code Example for MBED OS </b></a></li>
<li><a href="https://github.com/Infineon/mtb-example-anycloud-wlan-lowpower"><b>LPA Middleware Code Example for FREERTOS </b></a></li>
<li><a href="https://github.com/Infineon/afr-example-wlan-lowpower"><b>LPA Middleware Code Example for AMAZON FREERTOS </b></a></li>
<li><a href="https://github.com/Infineon"><b>LPA Middleware Code Examples at GITHUB</b></a></li>
<li><a href="https://www.cypress.com/ModusToolboxDeviceConfig"><b>ModusToolbox Device Configurator Tool Guide</b></a></li>
<li><a href="https://www.cypress.com/documentation/technical-reference-manuals/psoc-6-mcu-psoc-63-ble-architecture-technical-reference"><b>PSoC 6 Technical Reference Manual</b></a></li>
<li><a href="http://www.cypress.com/ds218787"><b>PSoC 63 with BLE Datasheet Programmable System-on-Chip datasheet</b></a></li>
<li><a href="http://www.cypress.com"><b>Cypress Semiconductor</b></a></li>
</ul>
<p><b>Note</b> Links to other software component's documentation (middleware and PDL) point to Cypress GitHub and the latest available version of the software. To get documentation for a specific version, download it from GitHub and unzip the component archive. The documentation is available in the docs folder.</p>
<h1><a class="anchor" id="apis"></a>
LPA API</h1>
<p>LPA API's are documented below</p>
<h2><a class="anchor" id="section_apis"></a>
Utilities</h2>
<p>LPA utility API's used by LPA middle-ware</p>
<p> 
 <ul>
 <li><a href="group__lpautilities.html">LPA Utility API</a></li>
 </ul>
 <br>
  </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Low Power Assistant Middleware Library 4.0.0</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
